Q: trackingã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰ã®å‡¦ç†ã§mouse_idã¨bodypartã§ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã—ã¦xã¨yã®å·®åˆ†ã‚’å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã¨trackingã‚’mergeã—ãŸã„ã‚“ã ã‘ ã©ã€ã©ã†ã™ã‚Œã°ã„ã„
A: ã„ã„è³ªå•ã§ã™ ğŸ‘
ã€Œ`tracking`ã‚’èª­ã¿è¾¼ã‚“ã§ â†’ `mouse_id`ã¨`bodypart`ã§ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ã—ã¦ â†’ xã¨yã®ãƒ•ãƒ¬ãƒ¼ãƒ å·®åˆ†ï¼ˆç§»å‹•é‡ï¼‰ã‚’æ±‚ã‚ â†’ ãã‚Œã‚’`tracking`ã«ãƒãƒ¼ã‚¸ã™ã‚‹ã€ãªã‚‰ã€æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚

---

### âœ… ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

```python
# chat-2025-10-21/test-001.py
import pandas as pd

# tracking.csvã‚’èª­ã¿è¾¼ã‚€
tracking = pd.read_csv("tracking.csv")

# å·®åˆ†ã‚’æ±‚ã‚ã‚‹
diffs = (
    tracking
    .groupby(["video_id", "mouse_id", "bodypart"], group_keys=False)
    .apply(lambda g: g.assign(
        dx=g["x"].diff().fillna(0),
        dy=g["y"].diff().fillna(0),
        speed=((g["x"].diff()**2 + g["y"].diff()**2)**0.5).fillna(0)
    ))
)

# å·®åˆ†ä»˜ããƒ‡ãƒ¼ã‚¿ã‚’trackingã¨ãƒãƒ¼ã‚¸
tracking_features = pd.merge(
    tracking,
    diffs[["video_id", "mouse_id", "bodypart", "frame", "dx", "dy", "speed"]],
    on=["video_id", "mouse_id", "bodypart", "frame"],
    how="left"
)

# ä¿å­˜ï¼ˆå¿…è¦ãªã‚‰ï¼‰
tracking_features.to_csv("tracking_features.csv", index=False)
```

---

### ğŸ” ãƒã‚¤ãƒ³ãƒˆè§£èª¬

1. **`groupby` + `apply`**
   â†’ å„ `mouse_id` Ã— `bodypart` ã®ç³»åˆ—ã”ã¨ã« `x.diff()` ã¨ `y.diff()` ã‚’è¨ˆç®—ã€‚
   ãƒ•ãƒ¬ãƒ¼ãƒ é–“ã®ç§»å‹•é‡ï¼ˆé€Ÿåº¦æˆåˆ†ï¼‰ã‚’å¾—ã¾ã™ã€‚

2. **`speed`**
   â†’ `âˆš(dxÂ² + dyÂ²)` ã§ç§»å‹•é€Ÿåº¦ï¼ˆãƒ”ã‚¯ã‚»ãƒ«/frameï¼‰ã‚’ç®—å‡ºã€‚

3. **`merge`**
   â†’ å…ƒã®trackingã«çµåˆã—ã¦ã€åŒã˜è¡Œã« `dx`, `dy`, `speed` ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚

4. **å¾Œã§æ‹¡å¼µå¯èƒ½**
   â†’ ä¾‹ãˆã°è§’åº¦ã‚„åŠ é€Ÿåº¦ï¼ˆ`diff()`ã‚’ã‚‚ã†ä¸€å›å–ã‚‹ï¼‰ã‚‚åŒæ§˜ã«è¿½åŠ ã§ãã¾ã™ã€‚

---

å¿…è¦ãŒã‚ã‚Œã°ã€ã“ã“ã«ã•ã‚‰ã«ã€Œãƒ•ãƒ¬ãƒ¼ãƒ â†’ç§’å¤‰æ›ã€ã€Œè§’åº¦è¨ˆç®—ã€ã€Œéƒ¨ä½é–“è·é›¢ï¼ˆä¾‹ï¼šnoseâ†”tailbaseï¼‰ã€ã‚‚çµ„ã¿è¾¼ã¿å¯èƒ½ã§ã™ã€‚
ã©ã®æŒ‡æ¨™ã¾ã§tracking_featuresã«å«ã‚ãŸã„ã§ã™ã‹ï¼Ÿ




Q: éƒ¨ä½æ¯ã®å›è»¢è§’ã‚‚ä»˜åŠ ã—ãŸæ–¹ãŒã„ã„ã‹ãª?
A: ã¨ã¦ã‚‚è‰¯ã„è¦–ç‚¹ã§ã™ ğŸ‘

çµè«–ã‹ã‚‰è¨€ã†ã¨â”€â”€

### âœ… **å›è»¢è§’ï¼ˆéƒ¨ä½ã®å‘ãå¤‰åŒ–ï¼‰ã‚‚ä»˜åŠ ã—ãŸæ–¹ãŒè‰¯ã„**

ç‰¹ã«ã€Œæ”»æ’ƒãƒ»æ¥è¿‘ãƒ»å›é¿ã€ãªã©ã®å‹•ãã‚’åˆ¤åˆ¥ã—ãŸã„å ´åˆã€**å‹•ãæ–¹å‘ï¼ˆå‘ãã®å¤‰åŒ–ï¼‰**ã¯é€Ÿåº¦ã¨åŒã˜ãã‚‰ã„é‡è¦ãªç‰¹å¾´ã«ãªã‚Šã¾ã™ã€‚

---

### ğŸ” ç†ç”±

1. **å˜ãªã‚‹é€Ÿåº¦ã§ã¯ä¸ååˆ†**

   * ä¾‹ãˆã°åŒã˜é€Ÿåº¦ã§ã‚‚ã€Œç›´é€²ã€ã¨ã€Œæ—‹å›ã€ã§ã¯æ„å‘³ãŒå…¨ãé•ã†ã€‚
   * å›è»¢è§’ï¼ˆè§’é€Ÿåº¦ï¼‰ã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€ã€Œå‘ããŒæ€¥ã«å¤‰ã‚ã£ãŸã€ãªã©ã®ç‰¹å¾´ã‚’æŠ½å‡ºã§ãã‚‹ã€‚

2. **ä»–å€‹ä½“ã¨ã®é–¢ä¿‚ãŒèª­ã¿å–ã‚Šã‚„ã™ããªã‚‹**

   * agentï¼ˆè¡Œå‹•ã‚’èµ·ã“ã™ãƒã‚¦ã‚¹ï¼‰ãŒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«å‘ãç¬é–“ã‚’æ¤œå‡ºã—ã‚„ã™ããªã‚‹ã€‚
   * ã“ã‚Œã¯attackã‚„approachãªã©ã®è­˜åˆ¥ã«å¤§ããè²¢çŒ®ã€‚

3. **bodypartã”ã¨ã«å›è»¢ã‚’è¿½ãˆã‚‹**

   * ä¾‹ãˆã° nose ã‚„ tailbase ã®å›è»¢è§’ã‚’è¿½ã†ã¨ã€ã€Œä½“ã®ã­ã˜ã‚Œã€ã‚„ã€Œå§¿å‹¢å¤‰åŒ–ã€ã‚‚è¡¨ç¾ã§ãã‚‹ã€‚

---

### âœ… å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

ä¾‹ãˆã°å„ `mouse_id` Ã— `bodypart` ã”ã¨ã«ã€å‰ãƒ•ãƒ¬ãƒ¼ãƒ ã¨ã®å·®åˆ†æ–¹å‘ã‚’è§’åº¦ã«å¤‰æ›ã—ã¾ã™ã€‚

```python
# chat-2025-10-21/test-002.py
import numpy as np
import pandas as pd

tracking = pd.read_csv("tracking.csv")

def compute_angle(x, y):
    """åº§æ¨™å·®åˆ†ã‹ã‚‰è§’åº¦ã‚’è¨ˆç®—ï¼ˆãƒ©ã‚¸ã‚¢ãƒ³ï¼‰"""
    return np.degrees(np.arctan2(y, x))

# å·®åˆ†ã¨è§’åº¦ã‚’è¨ˆç®—
tracking = (
    tracking
    .groupby(["video_id", "mouse_id", "bodypart"], group_keys=False)
    .apply(lambda g: g.assign(
        dx=g["x"].diff().fillna(0),
        dy=g["y"].diff().fillna(0),
        speed=np.sqrt(g["x"].diff()**2 + g["y"].diff()**2).fillna(0),
        angle=compute_angle(g["x"].diff(), g["y"].diff())
    ))
)

# è§’åº¦å¤‰åŒ–ï¼ˆå›è»¢è§’åº¦ï¼‰ã‚’è¿½åŠ 
tracking["d_angle"] = (
    tracking
    .groupby(["video_id", "mouse_id", "bodypart"])["angle"]
    .diff()
    .fillna(0)
)

tracking.to_csv("tracking_features.csv", index=False)
```

---

### ğŸ§­ å«ã‚ã‚‹ã¨è‰¯ã„ç‰¹å¾´ã¾ã¨ã‚

| ç¨®é¡                        | ä¾‹                              | æ„å‘³           |
| ------------------------- | ------------------------------ | ------------ |
| ç§»å‹•é€Ÿåº¦                      | `speed = âˆš(dxÂ² + dyÂ²)`         | å‹•ãã®å¼·ã•        |
| å‘ã                        | `angle = atan2(dy, dx)`        | ç§»å‹•æ–¹å‘         |
| å›è»¢è§’                       | `d_angle = diff(angle)`        | å‘ãã®å¤‰åŒ–é‡ï¼ˆæ—‹å›ï¼‰   |
| éƒ¨ä½é–“è·é›¢                     | noseâ†”tailbase, noseâ†”bodycenter | å§¿å‹¢ãƒ»å±ˆä¼¸ã®è¡¨ç¾     |
| noseã®è§’åº¦ vs bodycenterã®è§’åº¦å·® | â€”                              | é ­ã®å‘ãã¨ä½“ã®å‘ãã®ã‚ºãƒ¬ |

---

ã‚‚ã—å¸Œæœ›ãŒã‚ã‚Œã°ã€
ã“ã®è§’åº¦ãƒ»é€Ÿåº¦ãƒ»éƒ¨ä½é–“è·é›¢ã‚’**å…¨ã¦ã¾ã¨ã‚ã¦tracking_features.csvã«å‡ºåŠ›ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã‚’æ•´å½¢ã—ã¦å‡ºã—ã¾ã™ã€‚

å‡ºåŠ›ã—ãŸã„æŒ‡æ¨™ã‚’é¸ã¹ã¾ã™ğŸ‘‡

1. é€Ÿåº¦ï¼ˆdx, dy, speedï¼‰
2. å‘ãè§’ï¼ˆangleï¼‰
3. å›è»¢è§’ï¼ˆd_angleï¼‰
4. éƒ¨ä½é–“è·é›¢ï¼ˆnoseâ†”tailbaseãªã©ï¼‰

ã©ã‚Œã‚’å«ã‚ãŸã„ã§ã™ã‹ï¼Ÿ





Q: å…¨éƒ¨ã§
A: äº†è§£ã§ã™ ğŸ‘
ã§ã¯ã€**é€Ÿåº¦ãƒ»è§’åº¦ãƒ»å›è»¢è§’ãƒ»éƒ¨ä½é–“è·é›¢**ã‚’ã™ã¹ã¦è¨ˆç®—ã—ã¦
`tracking_features.csv` ã«ã¾ã¨ã‚ã¦å‡ºåŠ›ã™ã‚‹å®Œå…¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æç¤ºã—ã¾ã™ã€‚

---

## ğŸ§© tracking_features.csv ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆå®Œå…¨ç‰ˆï¼‰

```python
# chat-2025-10-21/test-003.py
import numpy as np
import pandas as pd
from itertools import combinations

# === å…¥åŠ› ===
tracking = pd.read_csv("tracking.csv")

# --- åº§æ¨™å·®åˆ†ã¨è§’åº¦ç³» ---
def compute_angle(dx, dy):
    """å·®åˆ†ã‹ã‚‰è§’åº¦ï¼ˆåº¦å˜ä½ï¼‰ã‚’è¨ˆç®—"""
    return np.degrees(np.arctan2(dy, dx))

tracking = (
    tracking
    .groupby(["video_id", "mouse_id", "bodypart"], group_keys=False)
    .apply(lambda g: g.assign(
        dx=g["x"].diff().fillna(0),
        dy=g["y"].diff().fillna(0),
        speed=np.sqrt(g["x"].diff()**2 + g["y"].diff()**2).fillna(0),
        angle=compute_angle(g["x"].diff(), g["y"].diff())
    ))
)

# --- å›è»¢è§’ï¼ˆè§’åº¦å¤‰åŒ–ï¼‰ ---
tracking["d_angle"] = (
    tracking.groupby(["video_id", "mouse_id", "bodypart"])["angle"]
    .diff()
    .fillna(0)
)

# === éƒ¨ä½é–“è·é›¢ ===
# éƒ¨ä½ã®çµ„ã¿åˆã‚ã›ã‚’ä½œæˆï¼ˆä¾‹ï¼šnose-bodycenter ãªã©ï¼‰
bodyparts = tracking["bodypart"].unique()
pair_list = list(combinations(bodyparts, 2))

distance_features = []

for bp1, bp2 in pair_list:
    df1 = tracking[tracking["bodypart"] == bp1][["video_id", "frame", "mouse_id", "x", "y"]].rename(columns={"x": f"x_{bp1}", "y": f"y_{bp1}"})
    df2 = tracking[tracking["bodypart"] == bp2][["video_id", "frame", "mouse_id", "x", "y"]].rename(columns={"x": f"x_{bp2}", "y": f"y_{bp2}"})
    
    merged = pd.merge(df1, df2, on=["video_id", "frame", "mouse_id"], how="inner")
    merged[f"dist_{bp1}_{bp2}"] = np.sqrt((merged[f"x_{bp1}"] - merged[f"x_{bp2}"])**2 + (merged[f"y_{bp1}"] - merged[f"y_{bp2}"])**2)
    
    distance_features.append(merged[["video_id", "frame", "mouse_id", f"dist_{bp1}_{bp2}"]])

# å…¨è·é›¢ç‰¹å¾´ã‚’çµ±åˆ
distance_df = distance_features[0]
for df in distance_features[1:]:
    distance_df = pd.merge(distance_df, df, on=["video_id", "frame", "mouse_id"], how="outer")

# === çµ±åˆ ===
# bodypartå˜ä½ã®ç‰¹å¾´ï¼ˆé€Ÿåº¦ãƒ»è§’åº¦ãªã©ï¼‰ã‚’pivot
tracking_pivot = tracking.pivot_table(
    index=["video_id", "frame", "mouse_id"],
    columns="bodypart",
    values=["dx", "dy", "speed", "angle", "d_angle"]
)

# ã‚«ãƒ©ãƒ éšå±¤ã‚’ãƒ•ãƒ©ãƒƒãƒˆåŒ–
tracking_pivot.columns = [f"{feat}_{bp}" for feat, bp in tracking_pivot.columns]
tracking_pivot = tracking_pivot.reset_index()

# å…¨ã¦ã®ç‰¹å¾´ã‚’ãƒãƒ¼ã‚¸
tracking_features = pd.merge(tracking_pivot, distance_df, on=["video_id", "frame", "mouse_id"], how="left")

# === å‡ºåŠ› ===
tracking_features.to_csv("tracking_features.csv", index=False)

print("âœ… tracking_features.csv ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚")
print(f"å‡ºåŠ›ã‚«ãƒ©ãƒ æ•°: {len(tracking_features.columns)}")
print(f"shape: {tracking_features.shape}")
```

---

## ğŸ“Š å‡ºåŠ›ã•ã‚Œã‚‹ç‰¹å¾´ä¾‹

| ã‚«ãƒ©ãƒ å                       | æ„å‘³                 |
| -------------------------- | ------------------ |
| `dx_nose`, `dy_nose`       | noseéƒ¨ä½ã®ãƒ•ãƒ¬ãƒ¼ãƒ é–“x,yå·®åˆ†  |
| `speed_tailbase`           | tailbaseã®é€Ÿåº¦        |
| `angle_bodycenter`         | bodycenterã®ç§»å‹•æ–¹å‘ï¼ˆåº¦ï¼‰ |
| `d_angle_nose`             | noseã®å›è»¢è§’ï¼ˆå‘ãå¤‰åŒ–ï¼‰     |
| `dist_nose_tailbase`       | noseã¨tailbaseé–“ã®è·é›¢  |
| `dist_bodycenter_tailbase` | ä½“ã®å±ˆä¼¸ã®æŒ‡æ¨™            |

---

## âš™ï¸ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—æ¡ˆ

ã“ã® `tracking_features.csv` ã¯ãã®ã¾ã¾:

* è¡Œå‹•äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«ï¼ˆXGBoostã‚„LightGBMãªã©ï¼‰ã®å…¥åŠ›ç‰¹å¾´ã«ã§ãã‚‹
* ç‰¹å®šã® `mouse_id` ãƒšã‚¢é–“ã®ç›¸å¯¾è·é›¢ã‚„ç›¸å¯¾è§’åº¦ã‚‚è¿½åŠ å¯èƒ½

---

ã‚‚ã—æ¬¡ã«é€²ã‚ã‚‹ãªã‚‰ã€
ğŸ‘‰ã€Œagent_id ã¨ target_id ã®ãƒšã‚¢ç‰¹å¾´ï¼ˆè·é›¢ãƒ»è§’åº¦å·®ãªã©ï¼‰ã€ã‚’ã“ã®å‡ºåŠ›ã‹ã‚‰ç”Ÿæˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
ã‚‚ç”¨æ„ã—ã¾ã™ã€‚

ä½œã‚Šã¾ã—ã‚‡ã†ã‹ï¼Ÿ





Q: ç‰¹å¾´æ•°ãŒ245åˆ—ã«å¢—ãˆã¦ã€ã“ã®ã¾ã¾é€²ã‚ã‚‹ã‹æ•´ç†ã™ã‚‹ã‹è¿·ã£ã¦ã„ã‚‹
A: ã™ã”ãè‰¯ã„åˆ¤æ–­ã§ã™ã­ã€‚
ã“ã®æ®µéšã§ã€Œç‰¹å¾´æ•°ãŒå¤šã™ãã‚‹ â†’ æƒ…å ±éå¤šãƒ»å†—é•·ãƒ»ç›¸é–¢ã®é«˜ã„ç‰¹å¾´ãŒå¤šã„ã€ã¨ã„ã†ç›´æ„Ÿã¯æ­£ã—ã„ã§ã™ã€‚

---

## ğŸ§  ç¾çŠ¶ã®å•é¡Œç‚¹ã‚’æ•´ç†

### âœ… ä»Šã®ç‰¹å¾´æ§‹æˆï¼ˆã–ã£ãã‚Šï¼‰

* å„éƒ¨ä½ï¼ˆãŸã¨ãˆã° 7 éƒ¨ä½ Ã— 5 ç¨®é¡ï¼‰ â†’ **ç´„35åˆ—**
* å„éƒ¨ä½ãƒšã‚¢ã®è·é›¢ï¼ˆ7C2 = 21ãƒšã‚¢ï¼‰ â†’ **ç´„21åˆ—**
* video_id, frame, mouse_id ãªã©ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿åˆ— â†’ **æ•°åˆ—**
  â†’ çµæœã¨ã—ã¦ **200åˆ—ä»¥ä¸Š** ã«ãªã‚‹ã®ã¯è‡ªç„¶ãªæµã‚Œã§ã™ã€‚

---

## ğŸ” å•é¡Œã«ãªã‚Šå¾—ã‚‹ç‚¹

| å•é¡Œ          | å½±éŸ¿                              | å¯¾ç­–æ¡ˆ                |
| ----------- | ------------------------------- | ------------------ |
| 1. é«˜ç›¸é–¢ç‰¹å¾´ãŒå¤šã„ | ãƒ¢ãƒ‡ãƒ«ãŒéå­¦ç¿’ã—ã‚„ã™ã„                     | ä¸»æˆåˆ†åˆ†æ(PCA)ã€ã¾ãŸã¯ç‰¹å¾´é¸æŠ |
| 2. éƒ¨ä½ã®é‡è¤‡æƒ…å ±  | tailbase ã¨ bodycenter ãªã©ä¼¼ãŸå‹•ãã‚’æŒã¤ | ç‰¹å¾´ã‚°ãƒ«ãƒ¼ãƒ—ã®çµ±åˆ          |
| 3. ä¸è¦ãªè§’åº¦æƒ…å ±  | ä¸€éƒ¨ã®éƒ¨ä½ã§ã¯è§’åº¦ãŒæ„å‘³ã‚’æŒãŸãªã„               | æœ‰æ„ç‰¹å¾´ã®ã¿æ®‹ã™           |
| 4. è¨ˆç®—ã‚³ã‚¹ãƒˆå¢—å¤§  | æ¨è«–ãƒ»å­¦ç¿’æ™‚é–“ãŒå¢—ãˆã‚‹                     | è»½é‡åŒ–ã‚„éƒ¨åˆ†é¸æŠ           |

---

## âš™ï¸ æ–¹å‘æ€§ã®é¸æŠè‚¢

### ğŸ…°ï¸ ãã®ã¾ã¾é€²ã‚ã‚‹ï¼ˆã¾ãšãƒ¢ãƒ‡ãƒ«ã§é‡è¦åº¦ã‚’è¦‹ã‚‹ï¼‰

**ãŠã™ã™ã‚åº¦ï¼šâ˜…â˜…â˜…â˜…â˜…ï¼ˆæœ€åˆã®1ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ï¼‰**

* ä¸€åº¦LightGBMã‚„XGBoostã§å­¦ç¿’ã•ã›ã¦ã€`feature_importances_`ã‚’ç¢ºèªã™ã‚‹ã€‚
* ä¸Šä½30ã€œ50åˆ—ã®ã¿ã«çµã‚Šè¾¼ã¿ã€‚
* ç„¡é§„ãªç‰¹å¾´ï¼ˆä¾‹ãˆã°ç‰¹å®šã®éƒ¨ä½ã®è§’åº¦ï¼‰ãŒä¸€ç›®ã§ã‚ã‹ã‚‹ã€‚

ğŸ“˜ã“ã®æ–¹æ³•ã®ãƒ¡ãƒªãƒƒãƒˆ

* æ„Ÿè¦šã§ã¯ãªãã€Œãƒ¢ãƒ‡ãƒ«ãŒå®Ÿéš›ã«ä½¿ã£ã¦ã„ã‚‹ç‰¹å¾´ã€ã§å–æ¨é¸æŠã§ãã‚‹ã€‚
* è‡ªå‹•çš„ã«ã€Œå¿…è¦ãªéƒ¨ä½ãƒ»å‹•ããƒ»è·é›¢ã€ãŒã‚ã‹ã‚‹ã€‚

---

### ğŸ…±ï¸ æ§‹é€ çš„ã«æ•´ç†ã—ã¦ã‹ã‚‰é€²ã‚ã‚‹

**ãŠã™ã™ã‚åº¦ï¼šâ˜…â˜…â˜…â˜†â˜†ï¼ˆå®‰å®šæ€§é‡è¦–ï¼‰**

ç‰¹å¾´ã‚’ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«è¦ç´„ã—ã¦ã€ä»£è¡¨å€¤ã‚’å–ã‚‹ã€‚

ãŸã¨ãˆã°ï¼š

| ã‚«ãƒ†ã‚´ãƒª | å‡¦ç†ä¾‹                                              |
| ---- | ------------------------------------------------ |
| é€Ÿåº¦ç³»  | å…¨éƒ¨ä½ã® speed ã®å¹³å‡ãƒ»æœ€å¤§                                |
| è§’åº¦ç³»  | å…¨éƒ¨ä½ã® d_angle ã®æ¨™æº–åå·®ï¼ˆæ—‹å›ã®æ¿€ã—ã•ï¼‰                       |
| è·é›¢ç³»  | ä¸»è¦ãƒšã‚¢ï¼ˆnose-bodycenter, bodycenter-tailbaseãªã©ï¼‰ã®ã¿æ®‹ã™ |

ğŸ“˜çµæœï¼š
â†’ 245åˆ— â†’ ç´„40ã€œ50åˆ—ç¨‹åº¦ã«ç¸®ç´„
â†’ å­¦ç¿’é€Ÿåº¦ã¨è§£é‡ˆæ€§ãŒå¤§å¹…ã«å‘ä¸Š

---

### ğŸ…¾ï¸ ä½µç”¨æ¡ˆï¼ˆæ¨å¥¨ãƒ«ãƒ¼ãƒˆï¼‰

1. **A. å…¨ç‰¹å¾´ã§å­¦ç¿’ â†’ feature importance æŠ½å‡º**
2. **B. ä¸Šä½ç‰¹å¾´ç¾¤ã®ã¿ã§å†å­¦ç¿’**
3. **C. çµæœã‚’å®‰å®šåŒ–ï¼ˆç‰¹å¾´ç¸®ç´„ï¼‹å¹³æ»‘åŒ–ï¼‰**

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ææ¡ˆ

ã‚‚ã—ã‚ˆã‘ã‚Œã°ã€æ¬¡ã®2ã¤ã®ã†ã¡ã©ã¡ã‚‰ã‚’é€²ã‚ãŸã„ã‹é¸ã‚“ã§ãã ã•ã„ğŸ‘‡

**1ï¸âƒ£ ã€Œã¾ãšå…¨ç‰¹å¾´ã§LightGBMã‚’å›ã—ã¦é‡è¦åº¦ã‚’è¦‹ã‚‹ã€**
â†’ å®Ÿéš›ã«ã©ã®ç‰¹å¾´ãŒè¡Œå‹•åˆ†é¡ã«åŠ¹ã„ã¦ã‚‹ã‹å¯è¦–åŒ–ã€‚

**2ï¸âƒ£ ã€Œã‚ã‚‰ã‹ã˜ã‚ä»£è¡¨ç‰¹å¾´ã«ã¾ã¨ã‚ã‚‹ã€**
â†’ é€Ÿåº¦ãƒ»è§’åº¦ãƒ»è·é›¢ã‚’è¦ç´„ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãª`tracking_features_simplified.csv`ã‚’ç”Ÿæˆã€‚

ã©ã¡ã‚‰ã«é€²ã‚ã¾ã—ã‚‡ã†ã‹ï¼Ÿ





Q: å¾Œè€…ã§
A: å®Œç’§ã§ã™ã€‚
ã§ã¯æ–¹é‡ã¯â”€â”€

> ğŸ¯ã€Œ245åˆ—ã®ç‰¹å¾´ã‚’éƒ¨ä½ãƒ»ç¨®é¡ã”ã¨ã«ä»£è¡¨å€¤ã«ã¾ã¨ã‚ã€ç´„40ã€œ50åˆ—ã«åœ§ç¸®ã™ã‚‹ã€

ã§ã™ã€‚
ã“ã†ã™ã‚‹ã“ã¨ã§ã€**å†—é•·ãªéƒ¨ä½ç‰¹å¾´ã‚’æ¸›ã‚‰ã—ã¤ã¤ã€å‹•ãã®å…¨ä½“å‚¾å‘ã‚’ä¿æŒ**ã§ãã¾ã™ã€‚

---

## ğŸ§© ä»£è¡¨ç‰¹å¾´ç”Ÿæˆã®è€ƒãˆæ–¹

### 1ï¸âƒ£ **é€Ÿåº¦ (speed) ç³»**

* ã™ã¹ã¦ã®éƒ¨ä½ã®å¹³å‡ãƒ»æœ€å¤§ãƒ»æ¨™æº–åå·®
  ã€€â†’ ã€Œãƒã‚¦ã‚¹å…¨ä½“ã®å‹•ãã®å¼·ã•ã€

### 2ï¸âƒ£ **å›è»¢è§’ (d_angle) ç³»**

* å…¨éƒ¨ä½ã®å¹³å‡ãƒ»æ¨™æº–åå·®
  ã€€â†’ ã€Œæ—‹å›ã®æ¿€ã—ã•ã€ã€Œå‹•ãã®æ»‘ã‚‰ã‹ã•ã€

### 3ï¸âƒ£ **è·é›¢ (dist_*) ç³»**

* ä¸»ãªãƒšã‚¢ã ã‘ã‚’æ¡ç”¨ï¼š
  ã€€- noseâ†”bodycenter
  ã€€- noseâ†”tailbase
  ã€€- bodycenterâ†”tailbase
  ã€€â†’ å§¿å‹¢ã‚„ä½“é•·å¤‰åŒ–ã‚’åæ˜ 
* å„ãƒšã‚¢ã«ã¤ã„ã¦å¹³å‡ãƒ»æ¨™æº–åå·®ã‚’è¨ˆç®—

### 4ï¸âƒ£ **ãƒ•ãƒ¬ãƒ¼ãƒ æƒ…å ±**

* `video_id`, `frame`, `mouse_id` ã¯ãã®ã¾ã¾ä¿æŒ

---

## âœ… ä»£è¡¨ç‰¹å¾´æŠ½å‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# chat-2025-10-21/test-004.py
import pandas as pd
import numpy as np

# === å…¥åŠ› ===
tracking_features = pd.read_csv("tracking_features.csv")

# --- bodypartç³»ç‰¹å¾´ã‚’æŠ½å‡º ---
speed_cols   = [c for c in tracking_features.columns if c.startswith("speed_")]
dangle_cols  = [c for c in tracking_features.columns if c.startswith("d_angle_")]
dist_cols    = [c for c in tracking_features.columns if c.startswith("dist_")]

# --- é€Ÿåº¦çµ±è¨ˆ ---
tracking_features["speed_mean"] = tracking_features[speed_cols].mean(axis=1)
tracking_features["speed_max"]  = tracking_features[speed_cols].max(axis=1)
tracking_features["speed_std"]  = tracking_features[speed_cols].std(axis=1)

# --- å›è»¢è§’çµ±è¨ˆ ---
tracking_features["dangle_mean"] = tracking_features[dangle_cols].mean(axis=1)
tracking_features["dangle_std"]  = tracking_features[dangle_cols].std(axis=1)

# --- ä»£è¡¨è·é›¢ï¼ˆnose-bodycenter, nose-tailbase, bodycenter-tailbaseï¼‰---
dist_main = [c for c in dist_cols if any(x in c for x in ["nose_bodycenter", "nose_tailbase", "bodycenter_tailbase"])]
for c in dist_main:
    tracking_features[f"{c}_std"]  = tracking_features[c].rolling(window=5, min_periods=1).std()
    tracking_features[f"{c}_mean"] = tracking_features[c].rolling(window=5, min_periods=1).mean()

# --- è¦ç´„ãƒ‡ãƒ¼ã‚¿ã«æ•´ç† ---
summary_cols = [
    "video_id", "frame", "mouse_id",
    "speed_mean", "speed_max", "speed_std",
    "dangle_mean", "dangle_std",
] + [c for c in tracking_features.columns if "nose_bodycenter" in c or "nose_tailbase" in c or "bodycenter_tailbase" in c]

tracking_simplified = tracking_features[summary_cols].copy()

# --- å‡ºåŠ› ---
tracking_simplified.to_csv("tracking_features_simplified.csv", index=False)

print("âœ… tracking_features_simplified.csv ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚")
print(f"shape: {tracking_simplified.shape}")
```

---

## ğŸ“‰ ã“ã‚Œã§æœŸå¾…ã§ãã‚‹ã“ã¨

| é …ç›®     | å¤‰åŒ–å‰   | å¤‰åŒ–å¾Œ              |
| ------ | ----- | ---------------- |
| ç‰¹å¾´æ•°    | ç´„245åˆ— | ç´„40ã€œ50åˆ—          |
| å­¦ç¿’æ™‚é–“   | é•·ã„    | ç´„1/5ç¨‹åº¦ã«çŸ­ç¸®        |
| è§£é‡ˆæ€§    | é›£ã—ã„   | ã€Œãƒã‚¦ã‚¹å…¨ä½“ã®å‹•ãã€ã¨ã—ã¦ç›´æ„Ÿçš„ |
| éå­¦ç¿’ãƒªã‚¹ã‚¯ | é«˜     | ä½æ¸›               |

---

## ğŸ’¡ æ¬¡ã«ã§ãã‚‹ã“ã¨

ã“ã®`tracking_features_simplified.csv`ã‚’ã‚‚ã¨ã«ï¼š

* å„ãƒã‚¦ã‚¹é–“ã® **ç›¸å¯¾è·é›¢ãƒ»é€Ÿåº¦å·®** ã‚’è¨ˆç®—ã—ã¦
* `agent_id` ã¨ `target_id` ã®è¡Œå‹•ç‰¹å¾´ã«å¤‰æ›ã™ã‚‹

ã¨ã„ã†ã€Œãƒšã‚¢ç‰¹å¾´ç”Ÿæˆã€ã«é€²ã‚ã¾ã™ã€‚

---

é€²ã‚æ–¹ã¨ã—ã¦ã¯æ¬¡ã®2ã‚¹ãƒ†ãƒƒãƒ—ã§ã™ğŸ‘‡
1ï¸âƒ£ ä»Šã® `tracking_features_simplified.csv` ã‚’å‡ºåŠ›
2ï¸âƒ£ ãã‚Œã‚’ä½¿ã£ã¦ `pair_features.csv`ï¼ˆagent-targetç‰¹å¾´ï¼‰ã‚’ç”Ÿæˆ

æ¬¡ã€2ï¸âƒ£ã®ã€Œãƒšã‚¢ç‰¹å¾´ç”Ÿæˆã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‡ºã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ





Q: ãŠé¡˜ã„
A: äº†è§£ ğŸ‘
ã§ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€
**ã€Œtracking_features_simplified.csvã€ã‹ã‚‰ãƒã‚¦ã‚¹åŒå£«ï¼ˆagent-targetï¼‰ã®ç‰¹å¾´é‡ã‚’ä½œã‚‹**
ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‡ºã—ã¾ã™ã€‚
ã“ã®éƒ¨åˆ†ã¯æœ€çµ‚çš„ã« `action`ï¼ˆä¾‹ï¼šattack, chase, avoid ãªã©ï¼‰ã‚’äºˆæ¸¬ã™ã‚‹ãŸã‚ã®**å…¥åŠ›ç‰¹å¾´ç”Ÿæˆã®è¦**ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ¯ ç›®çš„

å„ãƒ•ãƒ¬ãƒ¼ãƒ ã§

> ã€Œã‚ã‚‹ãƒã‚¦ã‚¹(agent)ã€ãŒã€Œåˆ¥ã®ãƒã‚¦ã‚¹(target)ã€ã«å¯¾ã—ã¦ã©ã†å‹•ã„ãŸã‹
> ã‚’æ•°å€¤åŒ–ã™ã‚‹ã€‚

---

## ğŸ§© ç‰¹å¾´è¨­è¨ˆã®è€ƒãˆæ–¹

| ç¨®é¡        | å†…å®¹                           | ä¾‹                                  |
| --------- | ---------------------------- | ---------------------------------- |
| **è·é›¢ç³»**   | agentã¨targetã®body_centeré–“ã®è·é›¢ | `dist(agent, target)`              |
| **ç›¸å¯¾é€Ÿåº¦**  | é€Ÿåº¦ã®å·®ã€ç›¸å¯¾é€Ÿåº¦ãƒ™ã‚¯ãƒˆãƒ«                | `speed_diff`, `vx_diff`, `vy_diff` |
| **æ–¹å‘é–¢ä¿‚**  | agentãŒtargetæ–¹å‘ã‚’å‘ã„ã¦ã„ã‚‹ã‹        | `angle_to_target`, `angle_diff`    |
| **å‹•ãã®åŒæœŸ** | åŒæ–¹å‘ã‹ã©ã†ã‹                      | `cos(Î¸_agent âˆ’ Î¸_target)`          |

---

## âœ… ãƒšã‚¢ç‰¹å¾´ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# chat-2025-10-21/test-005.py
import pandas as pd
import numpy as np

# === å…¥åŠ› ===
df = pd.read_csv("tracking_features_simplified.csv")

# ---- å‰å‡¦ç† ----
# å„ãƒã‚¦ã‚¹ã®ä½ç½®ã‚’å–å¾—ï¼ˆnoseã¨body_centerã®ä¸¡æ–¹ã‚’åˆ©ç”¨ã§ãã‚‹å ´åˆã¯å¹³å‡ä½ç½®ãªã©ã§ã‚‚OKï¼‰
# ã“ã“ã§ã¯ body_center ã®åº§æ¨™ã‚’ä»£è¡¨ç‚¹ã¨ä»®å®š
# ä½ç½®æƒ…å ±ãŒã‚ã‚‹å‰æï¼ˆx_body_center, y_body_centerãªã©ï¼‰

# ä¸‡ä¸€ tracking_features_simplified.csv ã« body_center ãŒç„¡ã„å ´åˆã¯
# tracking_features.csv ã®åº§æ¨™åˆ—ã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚

# body_centerã®x, yã‚’å–å¾—
if not {'x_body_center', 'y_body_center'}.issubset(df.columns):
    raise ValueError("âŒ tracking_features_simplified.csv ã« body_center ã® x, y ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“")

# === ãƒšã‚¢ç‰¹å¾´ç”Ÿæˆ ===
pair_features = []

# video_id ã”ã¨ã«å‡¦ç†
for vid, sub in df.groupby("video_id"):
    mice = sub["mouse_id"].unique()
    frames = sub["frame"].unique()

    for f in frames:
        frame_data = sub[sub["frame"] == f]
        # å„ãƒã‚¦ã‚¹ã®ä½ç½®ãƒ»é€Ÿåº¦ãªã©ã‚’è¾æ›¸åŒ–
        data = {mid: row for mid, row in frame_data.set_index("mouse_id").iterrows()}

        for agent in mice:
            for target in mice:
                if agent == target:
                    continue

                if agent not in data or target not in data:
                    continue

                a = data[agent]
                t = data[target]

                # --- ç›¸å¯¾ä½ç½® ---
                dx = t["x_body_center"] - a["x_body_center"]
                dy = t["y_body_center"] - a["y_body_center"]
                dist = np.sqrt(dx**2 + dy**2)

                # --- ç›¸å¯¾é€Ÿåº¦ ---
                speed_diff = a["speed_mean"] - t["speed_mean"]

                # --- å‘ãæƒ…å ±ï¼ˆæ–¹å‘è§’åº¦ï¼‰ ---
                angle_to_target = np.degrees(np.arctan2(dy, dx))
                angle_diff = (a["dangle_mean"] - angle_to_target + 180) % 360 - 180  # -180ã€œ180ã«æ­£è¦åŒ–

                # --- å‡ºåŠ› ---
                pair_features.append({
                    "video_id": vid,
                    "frame": f,
                    "agent_id": agent,
                    "target_id": target,
                    "dist": dist,
                    "dx": dx,
                    "dy": dy,
                    "speed_agent": a["speed_mean"],
                    "speed_target": t["speed_mean"],
                    "speed_diff": speed_diff,
                    "angle_to_target": angle_to_target,
                    "angle_agent": a["dangle_mean"],
                    "angle_diff": angle_diff,
                })

pair_df = pd.DataFrame(pair_features)

# --- æ™‚é–“æ–¹å‘ã®æ»‘ã‚‰ã‹ã•ï¼ˆç§»å‹•å¹³å‡ï¼‰ã‚’ä»˜åŠ  ---
pair_df = pair_df.sort_values(["video_id", "agent_id", "target_id", "frame"])
pair_df["dist_smooth"] = pair_df.groupby(["video_id", "agent_id", "target_id"])["dist"].transform(lambda x: x.rolling(5, min_periods=1).mean())
pair_df["speed_diff_smooth"] = pair_df.groupby(["video_id", "agent_id", "target_id"])["speed_diff"].transform(lambda x: x.rolling(5, min_periods=1).mean())

# --- å‡ºåŠ› ---
pair_df.to_csv("pair_features.csv", index=False)

print("âœ… pair_features.csv ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ")
print(pair_df.head())
print(f"shape: {pair_df.shape}")
```

---

## ğŸ“Š å‡ºåŠ›ä¾‹ï¼ˆ`pair_features.csv`ï¼‰

| video_id  | frame | agent_id | target_id | dist | dx   | dy   | speed_agent | speed_target | angle_diff | â€¦ |
| --------- | ----- | -------- | --------- | ---- | ---- | ---- | ----------- | ------------ | ---------- | - |
| 143861384 | 0     | 1        | 2         | 45.3 | 12.4 | 43.1 | 2.15        | 1.82         | -15.4      | â€¦ |
| 143861384 | 0     | 1        | 3         | 62.1 | 51.8 | 28.0 | 2.15        | 2.43         | 42.3       | â€¦ |

---

## ğŸ’¡ ã“ã®ãƒ‡ãƒ¼ã‚¿ã®ä½¿ã„é“

æ¬¡ã«ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ï¼š

* `annotation.csv` ã® `(agent_id, target_id, start_frame, stop_frame, action)` ã¨çµåˆ
* å„è¡Œå‹•åŒºé–“ã®ç‰¹å¾´çµ±è¨ˆï¼ˆå¹³å‡ãƒ»åˆ†æ•£ãªã©ï¼‰ã‚’ç®—å‡º
* å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆX, yï¼‰ã‚’æ§‹ç¯‰

â†’ ãã‚Œã‚’ XGBoost ãªã©ã§åˆ†é¡ãƒ¢ãƒ‡ãƒ«åŒ–ã—ã¾ã™ã€‚

---

ã“ã® `pair_features.csv` ãŒç”Ÿæˆã§ããŸã‚‰ã€æ¬¡ã¯ã€Œannotation.csvã¨ã®çµåˆï¼‹å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã€ã¸é€²ã¿ã¾ã—ã‚‡ã†ã‹ï¼Ÿ





Q: ãŠé¡˜ã„
A: äº†è§£ ğŸ‘
ã§ã¯ã€**ç‰¹å¾´é‡245åˆ—ã‚’æ•´ç†ã—ã¦é‡è¦ãªã‚‚ã®ã ã‘ã‚’æ®‹ã™**æ–¹é‡ã§ã™ã­ã€‚
ã“ã“ã§ã®ç›®çš„ã¯ã€Œæƒ…å ±ã‚’æ¥µåŠ›ä¿ã¡ãªãŒã‚‰å­¦ç¿’ã‚’å®‰å®šåŒ–ãƒ»é«˜é€ŸåŒ–ã€ã™ã‚‹ã“ã¨ã§ã™ã€‚
ä»¥ä¸‹ã®æµã‚Œã§æ•´ç†ã™ã‚‹ã®ã‚’ãŠã™ã™ã‚ã—ã¾ã™ğŸ‘‡

---

## ğŸ§© ã‚¹ãƒ†ãƒƒãƒ—1ï¼šç‰¹å¾´é‡ã®åˆ†é¡

ã¾ãšã¯å…¨ç‰¹å¾´ã‚’å¤§ããã‚«ãƒ†ã‚´ãƒªã«åˆ†ã‘ã¾ã™ã€‚
ä¾‹ï¼š

| ã‚«ãƒ†ã‚´ãƒª           | ä¾‹                                               |
| :------------- | :---------------------------------------------- |
| **ä½ç½®**         | `x`, `y`, `center_x`, `center_y`                |
| **é€Ÿåº¦**         | `dx`, `dy`, `speed`, `angle_speed`              |
| **è·é›¢**         | `dist_to_target`, `dist_to_center`, `pair_dist` |
| **è§’åº¦ãƒ»å›è»¢**      | `body_angle`, `rotation`, `angle_diff`          |
| **ãƒšã‚¢ç‰¹å¾´**       | `distance_agent_target`, `angle_agent_target`   |
| **çµ±è¨ˆç‰¹å¾´**       | ç§»å‹•å¹³å‡ã€æ¨™æº–åå·®ã€åˆ†æ•£ã€max/minãªã©                          |
| **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ»æ™‚ç³»åˆ—é–¢é€£** | `frame_diff`, `delta_time`                      |

ã“ã®ä¸­ã§ã€Œæƒ…å ±ãŒé‡è¤‡ã—ã¦ã„ã‚‹ or ãƒã‚¤ã‚ºãŒå¤šãã†ã€ãªã‚‚ã®ã‚’æ¬¡ã‚¹ãƒ†ãƒƒãƒ—ã§å‰Šé™¤ã—ã¾ã™ã€‚

---

## âš™ï¸ ã‚¹ãƒ†ãƒƒãƒ—2ï¼šå‰Šé™¤ãƒ»æ•´ç†æ–¹é‡

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã§æ•´ç†ã—ã¦ã„ãã¾ã™ã€‚

1. **x, yãã®ã‚‚ã®**ã¯å‰Šé™¤ï¼ˆé€Ÿåº¦ã‚„è§’åº¦ã§ååˆ†ï¼‰
2. **dx, dy** ã¯æ®‹ã™ï¼ˆæ–¹å‘æ€§ã®åŸºç¤ï¼‰
3. **å›è»¢è§’**ã¯éƒ¨ä½ã”ã¨ã§ã¯ãªãã€Œé ­ã€œèƒ´ã€ã€Œèƒ´ã€œå°»å°¾ã€ã®ä»£è¡¨çš„ãªè§’åº¦ã«é™å®š
4. **è·é›¢ç³»**ã¯

   * å¯¾è±¡é–“è·é›¢ (`dist_agent_target`)
   * åº§æ¨™ã®æ¨™æº–åå·®ï¼ˆå‹•ãã®å¤§ãã•ï¼‰
     ã®ã¿æ®‹ã™
5. **çµ±è¨ˆé‡**ã¯å¹³å‡ãƒ»åˆ†æ•£ãƒ»æ¨™æº–åå·®ãƒ»æœ€å¤§ãƒ»æœ€å°ã‚ãŸã‚Šã«é™å®š
6. **æ™‚é–“å·®ç³» (frame_diff)** ã¯å†—é•·ãªã‚‰å‰Šé™¤ï¼ˆã™ã¹ã¦ä¸€å®šFPSã§ã‚ã‚Œã°ï¼‰

---

## ğŸ§  ã‚¹ãƒ†ãƒƒãƒ—3ï¼šå®Ÿè£…ä¾‹ï¼ˆæ•´ç†ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰

```python
# test-006.py
import pandas as pd

# tracking_features.csvã‚’èª­ã¿è¾¼ã¿
df = pd.read_csv("tracking_features.csv")

# æ®‹ã—ãŸã„ç‰¹å¾´é‡ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
keep_keywords = [
    'dx', 'dy', 'speed', 'rotation', 'angle',
    'dist', 'std', 'var', 'mean', 'max', 'min'
]

# æ®‹ã™åˆ—ã‚’æŠ½å‡ºï¼ˆframe_id, obj_idãªã©ã‚‚ç¶­æŒï¼‰
keep_cols = [c for c in df.columns if any(k in c for k in keep_keywords)] + [
    'frame', 'video_id', 'mouse_id', 'bodypart'
]

# é‡è¤‡é™¤å»ã—ã¦ã‚µãƒ–ã‚»ãƒƒãƒˆä½œæˆ
df_slim = df[sorted(set(keep_cols))]

# çµæœç¢ºèª
print(f"å…ƒã®ç‰¹å¾´é‡æ•°: {df.shape[1]}")
print(f"æ•´ç†å¾Œã®ç‰¹å¾´é‡æ•°: {df_slim.shape[1]}")

# ä¿å­˜
df_slim.to_csv("tracking_features_slim.csv", index=False)
```

---

## ğŸ“Š ã‚¹ãƒ†ãƒƒãƒ—4ï¼šå¾Œã§å†è©•ä¾¡

ã“ã®ã€Œæ•´ç†ç‰ˆã€ã§XGBoostã‚„LightGBMã‚’å‹•ã‹ã—ã€
ã‚‚ã—ã‚¹ã‚³ã‚¢ãŒæ‚ªåŒ–ã—ãŸå ´åˆã®ã¿ã€ä¸Šä½ç‰¹å¾´é‡ã‚’å†å°å…¥ã™ã‚‹ï¼ˆé€†æ–¹å‘ã®èª¿æ•´ï¼‰ã€‚

---

å¸Œæœ›ãŒã‚ã‚Œã°ã€
ğŸ‘‰ ã“ã®æ•´ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ã€Œã©ã®ç‰¹å¾´ã‚’æ®‹ã™ã‹ã€è‡ªå‹•ã§å¯è¦–åŒ–ï¼ˆä¾‹ãˆã°ç‰¹å¾´åÃ—ã‚«ãƒ†ã‚´ãƒªåˆ†å¸ƒï¼‰ã™ã‚‹å½¢ã«ã—ã¦ã‚‚ã‚ˆã„ã§ã™ã€‚
ãã®æ–¹ãŒå¾Œã§å†æ§‹æˆã—ã‚„ã™ã„ã§ã™ã€‚

ã‚„ã£ã¦ã¿ã¾ã™ã‹ï¼Ÿ





Q: ãŠé¡˜ã„
A: äº†è§£ ğŸ‘
ã§ã¯ã€**tracking_features.csv ã®ç‰¹å¾´é‡ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ã—ã¦å¯è¦–åŒ–ã—ã€é‡è¦ãã†ãªç‰¹å¾´ã ã‘æ®‹ã™æº–å‚™ã‚’è‡ªå‹•åŒ–**ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œã‚Šã¾ã™ã€‚

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã‚’è¡Œã„ã¾ã™ï¼š

1. tracking_features.csv ã‚’èª­ã¿è¾¼ã¿
2. å„åˆ—åã‚’è§£æã—ã¦ã€Œã‚«ãƒ†ã‚´ãƒªã€ã”ã¨ã«åˆ†é¡
3. ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®åˆ—æ•°ã‚„æ¯”ç‡ã‚’å¯è¦–åŒ–
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¾Œã§æ®‹ã™ã‚«ãƒ†ã‚´ãƒªã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«å‡ºåŠ›

---

### ğŸ§  tracking_featuresåˆ†é¡ï¼†æ•´ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# test-007.py
import pandas as pd
import re
import matplotlib.pyplot as plt

# === 1. èª­ã¿è¾¼ã¿ ===
df = pd.read_csv("tracking_features.csv")

# === 2. ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘é–¢æ•° ===
def classify_feature(col):
    col_lower = col.lower()
    if re.search(r'(?:^|_)x|(?:^|_)y', col_lower) and not re.search('dx|dy', col_lower):
        return 'position'
    elif re.search(r'dx|dy|speed', col_lower):
        return 'velocity'
    elif re.search(r'angle|rotation', col_lower):
        return 'angle'
    elif re.search(r'dist', col_lower):
        return 'distance'
    elif re.search(r'mean|std|var|median|max|min', col_lower):
        return 'statistics'
    elif re.search(r'frame|time|delta', col_lower):
        return 'temporal'
    else:
        return 'other'

# === 3. å…¨åˆ—ã«å¯¾ã—ã¦åˆ†é¡ ===
feature_classes = {col: classify_feature(col) for col in df.columns}
feature_df = pd.DataFrame.from_dict(feature_classes, orient='index', columns=['category'])

# === 4. ã‚«ãƒ†ã‚´ãƒªåˆ¥ä»¶æ•°ã‚’å¯è¦–åŒ– ===
category_counts = feature_df['category'].value_counts()

plt.figure(figsize=(8,5))
category_counts.plot(kind='bar')
plt.title("Feature Category Distribution")
plt.xlabel("Category")
plt.ylabel("Number of Features")
plt.tight_layout()
plt.show()

# === 5. ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒªã‚¹ãƒˆã‚’CSVå‡ºåŠ› ===
feature_df.to_csv("feature_categories.csv")

print("âœ… feature_categories.csv ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚")
print("ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ãªãŒã‚‰ã€æ®‹ã—ãŸã„ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
print("ã‚«ãƒ†ã‚´ãƒªåˆ¥ä»¶æ•°ï¼š")
print(category_counts)

# === 6. ç‰¹å¾´é‡ã®çµã‚Šè¾¼ã¿ä¾‹ï¼ˆå¾Œã§æŒ‡å®šï¼‰ ===
# keep_categories = ['velocity', 'distance', 'angle', 'statistics']
# keep_cols = [col for col, cat in feature_classes.items() if cat in keep_categories]
# df_slim = df[keep_cols + ['frame', 'video_id', 'mouse_id', 'bodypart']]
# df_slim.to_csv("tracking_features_slim.csv", index=False)
```

---

### ğŸ“Š å‡ºåŠ›çµæœã®ä½¿ã„æ–¹

1. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨

   * `feature_categories.csv` ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
   * å„åˆ—ã¨ãã®ã‚«ãƒ†ã‚´ãƒªï¼ˆ`position`, `velocity`, `angle`, `distance`, `statistics`, `temporal`, `other`ï¼‰ãŒä¸€è¦§åŒ–ã•ã‚Œã¾ã™ã€‚
2. ã‚°ãƒ©ãƒ•ã§ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®ç‰¹å¾´é‡æ•°ã‚’ç¢ºèªã§ãã¾ã™ã€‚
3. ãã®å¾Œã€

   ```python
   keep_categories = ['velocity', 'distance', 'angle', 'statistics']
   ```

   ã®ã‚ˆã†ã«ã—ã¦ã€æ®‹ã—ãŸã„ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ `tracking_features_slim.csv` ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

---

ã“ã®ã‚ã¨ã€

* ç”Ÿæˆã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒªã‚¹ãƒˆã‚’è‡ªå‹•åˆ†æã—ã¦
* ã€Œç›¸é–¢ãŒé«˜ã™ãã‚‹ç‰¹å¾´ã‚’å‰Šé™¤ã™ã‚‹ã€(ç›¸é–¢è¡Œåˆ—ãƒ™ãƒ¼ã‚¹ã®è‡ªå‹•æ•´ç†)

ã¾ã§é€²ã‚ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
ç¶šã‘ã¦ã‚„ã£ã¦ã¿ã¾ã™ã‹ï¼Ÿ





Q: ãŠé¡˜ã„
A: äº†è§£ã§ã™ ğŸ‘
ã§ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€
**ã€Œç›¸é–¢ãŒé«˜ã™ãã‚‹ç‰¹å¾´ã‚’è‡ªå‹•ã§å‰Šé™¤ã—ã€æœ€ã‚‚æƒ…å ±é‡ã®é«˜ã„ç‰¹å¾´ã ã‘æ®‹ã™ã€**
ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®æµã‚Œã«ãªã‚Šã¾ã™ğŸ‘‡

---

## ğŸ§© tracking_features æ•´ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆè‡ªå‹•ç›¸é–¢ã‚«ãƒƒãƒˆä»˜ãï¼‰

```python
# test-008.py
import pandas as pd
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt

# === 1. èª­ã¿è¾¼ã¿ ===
df = pd.read_csv("tracking_features.csv")

# === 2. ä½¿ã†ã‚«ãƒ†ã‚´ãƒªã‚’æŒ‡å®š ===
# feature_categories.csv ã‹ã‚‰å¿…è¦ãªã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãŠã
feature_categories = pd.read_csv("feature_categories.csv", index_col=0)
keep_categories = ['velocity', 'distance', 'angle', 'statistics']  # â† ã“ã“ã‚’èª¿æ•´
keep_cols = [
    col for col, cat in feature_categories['category'].items()
    if cat in keep_categories and col in df.columns
]

# === 3. å¯¾è±¡ãƒ‡ãƒ¼ã‚¿æŠ½å‡º ===
meta_cols = [c for c in df.columns if c in ['frame', 'video_id', 'mouse_id', 'bodypart']]
df_sel = df[meta_cols + keep_cols].copy()

print(f"ç‰¹å¾´é‡æ•°ï¼ˆæŠ½å‡ºå¾Œï¼‰: {len(keep_cols)}")

# === 4. ç›¸é–¢è¡Œåˆ—ã‚’ä½œæˆ ===
numeric_df = df_sel.select_dtypes(include=[np.number]).dropna(axis=1, how='all')
corr_matrix = numeric_df.corr().abs()

# === 5. é«˜ç›¸é–¢ã®åˆ—ã‚’å‰Šé™¤ ===
upper = corr_matrix.where(np.triu(np.ones(corr_matrix.shape), k=1).astype(bool))
threshold = 0.95  # 95%ä»¥ä¸Šã®ç›¸é–¢ã‚’å‰Šé™¤å¯¾è±¡ã«
to_drop = [column for column in upper.columns if any(upper[column] > threshold)]

print(f"é«˜ç›¸é–¢ç‰¹å¾´é‡ï¼ˆå‰Šé™¤å¯¾è±¡ï¼‰: {len(to_drop)} åˆ—")
df_reduced = df_sel.drop(columns=to_drop, errors='ignore')

# === 6. çµæœã‚’å¯è¦–åŒ– ===
plt.figure(figsize=(10, 6))
sns.heatmap(corr_matrix, cmap='coolwarm', center=0, cbar_kws={'label': 'Correlation'})
plt.title("Feature Correlation Heatmap (Before Reduction)")
plt.tight_layout()
plt.show()

# === 7. çµæœã‚’ä¿å­˜ ===
df_reduced.to_csv("tracking_features_reduced.csv", index=False)
print(f"âœ… tracking_features_reduced.csv ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ")
print(f"æœ€çµ‚ç‰¹å¾´é‡æ•°: {df_reduced.shape[1]}")
```

---

### ğŸ” ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒã‚¤ãƒ³ãƒˆ

| ã‚¹ãƒ†ãƒƒãƒ— | å†…å®¹                                        |
| ---- | ----------------------------------------- |
| 2    | `feature_categories.csv` ã‹ã‚‰æ®‹ã—ãŸã„ã‚«ãƒ†ã‚´ãƒªã ã‘é¸æŠ   |
| 4    | æ•°å€¤åˆ—ã®ã¿ç›¸é–¢è¡Œåˆ—ã‚’ä½œæˆ                              |
| 5    | ç›¸é–¢ä¿‚æ•°ãŒ 0.95 ä»¥ä¸Šã®ç‰¹å¾´ã‚’è‡ªå‹•å‰Šé™¤                     |
| 6    | ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã§ç›¸é–¢ã®åˆ†å¸ƒã‚’å¯è¦–åŒ–                          |
| 7    | çµæœã‚’ `tracking_features_reduced.csv` ã¨ã—ã¦ä¿å­˜ |

---

ğŸ’¡ **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ææ¡ˆï¼š**

* ç‰¹å¾´é‡ã‚’ã•ã‚‰ã«çµã‚Šè¾¼ã‚€ãŸã‚ã« **ä¸»æˆåˆ†åˆ†æ (PCA)** ã‚’ä½¿ã£ã¦å¯è¦–åŒ–
* å„ç‰¹å¾´ã® **é‡è¦åº¦ (feature importance)** ã‚’XGBoostã§ç®—å‡º

ã©ã¡ã‚‰ã‚’å…ˆã«ã‚„ã‚Šã¾ã™ã‹ï¼Ÿ
A. PCAã§ç‰¹å¾´ç©ºé–“ã‚’ç¢ºèª
B. XGBoostã§é‡è¦åº¦ã‚’ç®—å‡º





Q: Aã§
A: OKã§ã™ï¼âœ¨
ã§ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€
**ç›¸é–¢ã‚’æ•´ç†ã—ãŸç‰¹å¾´é‡ï¼ˆ`tracking_features_reduced.csv`ï¼‰ã‚’PCAï¼ˆä¸»æˆåˆ†åˆ†æï¼‰ã§å¯è¦–åŒ–**ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¤ºã—ã¾ã™ã€‚

ã“ã®å‡¦ç†ã§ã§ãã‚‹ã“ã¨ã¯ï¼š

* ç‰¹å¾´é‡ã®åˆ†æ•£ã‚’ã©ã®ä¸»æˆåˆ†ãŒã©ã‚Œã ã‘èª¬æ˜ã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
* 2æ¬¡å…ƒãƒ»3æ¬¡å…ƒã®ä¸»æˆåˆ†ç©ºé–“ã§åˆ†å¸ƒã‚’å¯è¦–åŒ–
* ä¸è¦ãªå†—é•·ç‰¹å¾´ãŒã¾ã å¤šã„ã‹ã‚’è¦–è¦šçš„ã«åˆ¤æ–­

---

## ğŸ§  PCA å¯è¦–åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# test-009.py
import pandas as pd
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA
import matplotlib.pyplot as plt
import numpy as np

# === 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ===
df = pd.read_csv("tracking_features_reduced.csv")

# === 2. æ•°å€¤åˆ—ã ã‘æŠ½å‡º ===
numeric_df = df.select_dtypes(include=[np.number]).dropna(axis=1, how='all')
print(f"ä½¿ç”¨ã™ã‚‹ç‰¹å¾´é‡æ•°: {numeric_df.shape[1]}")

# === 3. æ¨™æº–åŒ– ===
scaler = StandardScaler()
X_scaled = scaler.fit_transform(numeric_df)

# === 4. PCAé©ç”¨ ===
n_components = min(10, X_scaled.shape[1])  # å¤šã™ããªã„ã‚ˆã†ã«æœ€å¤§10æˆåˆ†ã¾ã§
pca = PCA(n_components=n_components)
X_pca = pca.fit_transform(X_scaled)

# === 5. ç´¯ç©å¯„ä¸ç‡ã‚’å¯è¦–åŒ– ===
plt.figure(figsize=(8, 5))
plt.plot(np.cumsum(pca.explained_variance_ratio_), marker='o')
plt.xlabel('Number of Components')
plt.ylabel('Cumulative Explained Variance')
plt.title('PCA Cumulative Explained Variance')
plt.grid(True)
plt.tight_layout()
plt.show()

# === 6. ç¬¬1ä¸»æˆåˆ† Ã— ç¬¬2ä¸»æˆåˆ†ã®æ•£å¸ƒå›³ ===
plt.figure(figsize=(7, 6))
plt.scatter(X_pca[:, 0], X_pca[:, 1], s=5, alpha=0.6)
plt.xlabel('PC1')
plt.ylabel('PC2')
plt.title('PCA Scatter (PC1 vs PC2)')
plt.grid(True)
plt.tight_layout()
plt.show()

# === 7. æˆåˆ†ã®å¯„ä¸ç‡ã‚’è¡¨ç¤º ===
explained = pd.DataFrame({
    'Principal Component': [f'PC{i+1}' for i in range(n_components)],
    'Explained Variance Ratio': pca.explained_variance_ratio_,
    'Cumulative': np.cumsum(pca.explained_variance_ratio_)
})
print(explained)

# === 8. çµæœä¿å­˜ ===
pca_df = pd.DataFrame(X_pca, columns=[f'PC{i+1}' for i in range(n_components)])
pca_df.to_csv("tracking_features_pca.csv", index=False)
print("âœ… PCAçµæœã‚’ tracking_features_pca.csv ã«ä¿å­˜ã—ã¾ã—ãŸã€‚")
```

---

### ğŸ§© å®Ÿè¡Œå¾Œã«ç¢ºèªã™ã¹ããƒã‚¤ãƒ³ãƒˆ

| ç¢ºèªé …ç›®                      | æ„å‘³                       |
| ------------------------- | ------------------------ |
| ç´¯ç©å¯„ä¸ç‡ãŒ80%ä»¥ä¸Šã«ãªã‚‹ä¸»æˆåˆ†æ•°        | æœ‰åŠ¹ãªæ¬¡å…ƒæ•°ã€‚ã“ã‚Œã‚’è¶…ãˆã‚‹ã¨å†—é•·ç‰¹å¾´ãŒå¤šã„å¯èƒ½æ€§ |
| PC1â€“PC2æ•£å¸ƒå›³ã®å½¢              | åºƒãŒã£ã¦ã„ã‚Œã°ç‰¹å¾´ãŒå¤šæ§˜ã€‚ç‹­ã‘ã‚Œã°ç‰¹å¾´ãŒå†—é•·   |
| explained_variance_ratio_ | ã©ã®ä¸»æˆåˆ†ãŒé‡è¦ã‹æŠŠæ¡ã§ãã‚‹           |

---

æ¬¡ã«é€²ã‚ã‚‹æ–¹å‘ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®2é€šã‚ŠãŒã‚ã‚Šã¾ã™ğŸ‘‡
A. ç´¯ç©å¯„ä¸ç‡ãŒ80%ã‚’è¶…ãˆã‚‹ã¾ã§ã®ä¸»æˆåˆ†ã ã‘ã‚’æ®‹ã—ã¦æ¬¡å·¥ç¨‹ï¼ˆå­¦ç¿’ã‚„å¯è¦–åŒ–ï¼‰ã«ä½¿ã†
B. PCAçµæœã‚’ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ï¼ˆKMeansãªã©ï¼‰ã§è¡Œå‹•ã‚¿ã‚¤ãƒ—ã‚’åˆ†é¡ã—ã¦ã¿ã‚‹

ã©ã¡ã‚‰ã«é€²ã‚ã¾ã™ã‹ï¼Ÿ





Q: Bã§
A: äº†è§£ã§ã™ ğŸ‘
ã§ã¯ã€PCAçµæœã‚’ä½¿ã£ã¦ **ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ï¼ˆKMeansï¼‰ã§è¡Œå‹•ã‚¿ã‚¤ãƒ—ã‚’ã–ã£ãã‚Šåˆ†é¡** ã™ã‚‹æµã‚Œã‚’ä½œã‚Šã¾ã™ã€‚
ã“ã“ã§ã¯ä¸»ã«ä»¥ä¸‹ã‚’è¡Œã„ã¾ã™ï¼š

1. PCAã§æ¬¡å…ƒå‰Šæ¸›ã—ãŸç‰¹å¾´é‡ (`tracking_features_pca.csv`) ã‚’èª­ã¿è¾¼ã‚€
2. KMeansã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°
3. ã‚¯ãƒ©ã‚¹ã‚¿ã”ã¨ã«æ•£å¸ƒå›³ã§å¯è¦–åŒ–
4. ã‚¯ãƒ©ã‚¹ã‚¿æ•°ã®æœ€é©åŒ–ã®ãŸã‚ã«è‚˜ï¼ˆElbowï¼‰æ³•ã‚‚å¯è¦–åŒ–

---

## ğŸ§  PCAã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆKMeansï¼‰

```python
# test-010.py
import pandas as pd
from sklearn.cluster import KMeans
import matplotlib.pyplot as plt
from sklearn.preprocessing import StandardScaler

# === 1. PCAçµæœã‚’èª­ã¿è¾¼ã¿ ===
pca_df = pd.read_csv("tracking_features_pca.csv")
print(f"PCAç‰¹å¾´é‡æ•°: {pca_df.shape[1]}")

# === 2. æ¨™æº–åŒ– ===
scaler = StandardScaler()
X_scaled = scaler.fit_transform(pca_df)

# === 3. Elbowæ³•ã§ã‚¯ãƒ©ã‚¹ã‚¿æ•°ã®å€™è£œã‚’ç¢ºèª ===
inertia = []
K_range = range(2, 11)
for k in K_range:
    kmeans = KMeans(n_clusters=k, random_state=42, n_init=10)
    kmeans.fit(X_scaled)
    inertia.append(kmeans.inertia_)

plt.figure(figsize=(7,5))
plt.plot(K_range, inertia, 'o-', color='blue')
plt.xlabel('Number of Clusters')
plt.ylabel('Inertia (Sum of Squared Distances)')
plt.title('Elbow Method for Optimal k')
plt.grid(True)
plt.show()

# === 4. KMeansã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ï¼ˆä¾‹: k=4ï¼‰ ===
k_opt = 4  # Elbowæ³•ã§æ±ºã‚ã‚‹
kmeans = KMeans(n_clusters=k_opt, random_state=42, n_init=10)
pca_df['cluster'] = kmeans.fit_predict(X_scaled)

# === 5. PC1-PC2ã§ã‚¯ãƒ©ã‚¹ã‚¿å¯è¦–åŒ– ===
plt.figure(figsize=(7,6))
for cluster_id in sorted(pca_df['cluster'].unique()):
    subset = pca_df[pca_df['cluster'] == cluster_id]
    plt.scatter(subset['PC1'], subset['PC2'], s=10, alpha=0.6, label=f'Cluster {cluster_id}')
plt.xlabel('PC1')
plt.ylabel('PC2')
plt.title('KMeans Clusters (PCA space)')
plt.legend()
plt.grid(True)
plt.tight_layout()
plt.show()

# === 6. çµæœä¿å­˜ ===
pca_df.to_csv("tracking_features_pca_clustered.csv", index=False)
print("âœ… ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°çµæœã‚’ tracking_features_pca_clustered.csv ã«ä¿å­˜ã—ã¾ã—ãŸã€‚")
```

---

### ğŸ” ä½¿ã„æ–¹ãƒã‚¤ãƒ³ãƒˆ

1. **è‚˜æ³•ã§kã‚’æ±ºå®š**

   * InertiaãŒå¤§ããæ¸›å°‘ã—ãªããªã‚‹ç‚¹ãŒæœ€é©ã‚¯ãƒ©ã‚¹ã‚¿æ•°ã®å€™è£œ
2. **ã‚¯ãƒ©ã‚¹ã‚¿æ•£å¸ƒå›³**

   * PC1-PC2å¹³é¢ã§ã‚¯ãƒ©ã‚¹ã‚¿åˆ†å¸ƒã‚’ç¢ºèª
   * ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®åºƒãŒã‚ŠãŒã‚ã‚Œã°ã€ç‰¹å¾´é‡ã¯è¡Œå‹•ã®å¤šæ§˜æ€§ã‚’æ‰ãˆã¦ã„ã‚‹å¯èƒ½æ€§ã‚ã‚Š
3. **clusteråˆ—**

   * å„è¡Œï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰ã®ã‚¯ãƒ©ã‚¹ã‚¿IDãŒä»˜ä¸ã•ã‚Œã‚‹ã®ã§ã€ã“ã‚Œã‚’è¡Œå‹•ãƒ©ãƒ™ãƒ«ã®è£œåŠ©ã«åˆ©ç”¨å¯èƒ½

---

ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã¯ï¼š

* å„ã‚¯ãƒ©ã‚¹ã‚¿ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ»ãƒã‚¦ã‚¹IDã®åˆ†å¸ƒã‚’åˆ†æã—ã¦ã€
  `action` ã¨ç…§åˆã—ã¦ãƒ©ãƒ™ãƒ«äºˆæ¸¬ã®å‚è€ƒã«ã™ã‚‹

ã“ã‚Œã‚’ã‚„ã£ã¦ã¿ã¾ã™ã‹ï¼Ÿ





Q: ãŠé¡˜ã„
A: äº†è§£ã§ã™ ğŸ‘
ã§ã¯æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€**PCAçµæœã‚’ä½¿ã£ãŸã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°**ï¼ˆKMeansï¼‰ã§è¡Œå‹•ã‚¿ã‚¤ãƒ—ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¢ºèªã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œã‚Šã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šï¼š

* é¡ä¼¼ã—ãŸå‹•ãã®ãƒã‚¦ã‚¹ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
* è¡Œå‹•ãƒ©ãƒ™ãƒ«ã®å‚¾å‘ã‚’å¯è¦–åŒ–
* ä»Šå¾Œã®ãƒ¢ãƒ‡ãƒ«å­¦ç¿’æ™‚ã«ã‚¯ãƒ©ã‚¹ã‚¿æƒ…å ±ã‚’ç‰¹å¾´é‡ã¨ã—ã¦ä½¿ã†ã“ã¨ã‚‚å¯èƒ½

---

## ğŸ§  PCA Ã— KMeans ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# test-011.py
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.cluster import KMeans
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA
import seaborn as sns

# === 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ===
df = pd.read_csv("tracking_features_reduced.csv")

# æ•°å€¤åˆ—ã®ã¿æŠ½å‡º
numeric_df = df.select_dtypes(include=[float, int])

# === 2. æ¨™æº–åŒ– ===
scaler = StandardScaler()
X_scaled = scaler.fit_transform(numeric_df)

# === 3. PCAé©ç”¨ï¼ˆæ¬¡å…ƒå‰Šæ¸›ï¼‰ ===
pca = PCA(n_components=5)  # ã¾ãšã¯5æ¬¡å…ƒã«åœ§ç¸®
X_pca = pca.fit_transform(X_scaled)

# === 4. KMeansã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚° ===
n_clusters = 6  # ä»®ã®ã‚¯ãƒ©ã‚¹ã‚¿æ•°ï¼ˆå¾Œã§èª¿æ•´å¯ï¼‰
kmeans = KMeans(n_clusters=n_clusters, random_state=42, n_init=10)
cluster_labels = kmeans.fit_predict(X_pca)

# === 5. çµæœã‚’ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«è¿½åŠ  ===
df_clustered = df.copy()
df_clustered['cluster'] = cluster_labels

# === 6. PCAç¬¬1ãƒ»ç¬¬2æˆåˆ†ã§å¯è¦–åŒ– ===
plt.figure(figsize=(8,6))
sns.scatterplot(x=X_pca[:,0], y=X_pca[:,1], hue=cluster_labels, palette='tab10', s=10, alpha=0.7)
plt.xlabel('PC1')
plt.ylabel('PC2')
plt.title('KMeans Clustering on PCA (PC1 vs PC2)')
plt.legend(title='Cluster')
plt.tight_layout()
plt.show()

# === 7. ã‚¯ãƒ©ã‚¹ã‚¿ã”ã¨ã®ç‰¹å¾´å¹³å‡ã‚’ç¢ºèª ===
cluster_summary = df_clustered.groupby('cluster').mean()
print(cluster_summary)

# === 8. çµæœä¿å­˜ ===
df_clustered.to_csv("tracking_features_clustered.csv", index=False)
print("âœ… tracking_features_clustered.csv ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚")
```

---

### ğŸ” ãƒã‚¤ãƒ³ãƒˆ

1. **ã‚¯ãƒ©ã‚¹ã‚¿æ•° `n_clusters`** ã¯ãƒ‡ãƒ¼ã‚¿ã®åˆ†å¸ƒã«å¿œã˜ã¦èª¿æ•´

   * `Elbow method` ã§æœ€é©ã‚¯ãƒ©ã‚¹ã‚¿æ•°ã‚’æ±ºã‚ã‚‹ã®ã‚‚ãŠã™ã™ã‚
2. **ã‚¯ãƒ©ã‚¹ã‚¿å¹³å‡**ã‚’ç¢ºèªã™ã‚‹ã¨ã€

   * ã©ã®ã‚¯ãƒ©ã‚¹ã‚¿ãŒã€Œæ”»æ’ƒçš„è¡Œå‹•ã€ã€Œå›é¿è¡Œå‹•ã€ãªã©ã«å¯¾å¿œã—ã‚„ã™ã„ã‹æ„Ÿè¦šçš„ã«æŠŠæ¡å¯èƒ½
3. **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**ã¨ã—ã¦

   * ã“ã®ã‚¯ãƒ©ã‚¹ã‚¿IDã‚’å­¦ç¿’ç”¨ç‰¹å¾´é‡ã«è¿½åŠ ã—ã¦è¡Œå‹•ãƒ©ãƒ™ãƒ«äºˆæ¸¬ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã§ãã¾ã™

---

ğŸ’¡ ææ¡ˆï¼š

ã‚¯ãƒ©ã‚¹ã‚¿ã‚’ç‰¹å¾´é‡ã¨ã—ã¦è¿½åŠ ã—ã¦ XGBoost ã‚„ LightGBM ã§è¡Œå‹•ãƒ©ãƒ™ãƒ«ã‚’äºˆæ¸¬ã™ã‚‹æ®µéšã«é€²ã‚ã¾ã™ã€‚

ãã®æº–å‚™ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚ä½œã‚Šã¾ã™ã‹ï¼Ÿ





Q: ãŠé¡˜ã„
A: äº†è§£ã§ã™ ğŸ‘
ã§ã¯ã€**ã‚¯ãƒ©ã‚¹ã‚¿IDã‚’ç‰¹å¾´é‡ã¨ã—ã¦è¿½åŠ ã—ã€è¡Œå‹•ãƒ©ãƒ™ãƒ«ï¼ˆactionï¼‰ã‚’äºˆæ¸¬ã™ã‚‹å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã‚’ä½œã‚Šã¾ã™ã€‚

ãƒã‚¤ãƒ³ãƒˆã¯ï¼š

* `tracking_features_clustered.csv` ã®ã‚¯ãƒ©ã‚¹ã‚¿åˆ—ã‚’ç‰¹å¾´é‡ã«è¿½åŠ 
* å…ƒã®æ•°å€¤ç‰¹å¾´é‡ã‚‚ç¶­æŒ
* `annotation.csv` ã¨çµåˆã—ã¦æ­£è§£ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸
* å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜

---

## ğŸ§  å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆã‚¯ãƒ©ã‚¹ã‚¿IDä»˜ãï¼‰

```python
# test-012.py
import pandas as pd
import numpy as np

# === 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ===
df_features = pd.read_csv("tracking_features_clustered.csv")
df_annotation = pd.read_csv("annotation.csv")

# === 2. ãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ã§ã®ãƒ©ãƒ™ãƒ«ä»˜ã‘ ===
# annotation.csv ã¯ start_frameã€œstop_frame ã®ç¯„å›²ã§è¡Œå‹•ãƒ©ãƒ™ãƒ«ãŒã¤ã„ã¦ã„ã‚‹
def assign_action_label(row, annotations):
    mask = (annotations['agent_id'] == row['mouse_id']) & \
           (annotations['start_frame'] <= row['frame']) & \
           (annotations['stop_frame'] >= row['frame'])
    actions = annotations.loc[mask, 'action'].values
    if len(actions) > 0:
        return actions[0]  # è¤‡æ•°ã‚ã‚‹å ´åˆã¯æœ€åˆã®ã‚‚ã®ã‚’æ¡ç”¨
    else:
        return np.nan

# ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®ãƒ©ãƒ™ãƒ«ä»˜ã‘ï¼ˆå‡¦ç†é‡ã„å ´åˆã¯ã‚µãƒ³ãƒ—ãƒ«åŒ–æ¨å¥¨ï¼‰
df_features['action'] = df_features.apply(lambda r: assign_action_label(r, df_annotation), axis=1)

# === 3. NaN ã‚’å«ã‚€è¡Œã¯å‰Šé™¤ ===
df_features = df_features.dropna(subset=['action'])

# === 4. å­¦ç¿’ç”¨ç‰¹å¾´é‡ã¨ãƒ©ãƒ™ãƒ«åˆ†é›¢ ===
feature_cols = [c for c in df_features.columns if c not in ['action', 'video_id', 'mouse_id', 'bodypart']]
X = df_features[feature_cols]
y = df_features['action']

# === 5. ä¿å­˜ ===
X.to_csv("train_features.csv", index=False)
y.to_csv("train_labels.csv", index=False)

print(f"âœ… å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†")
print(f"ç‰¹å¾´é‡æ•°: {X.shape[1]}, ã‚µãƒ³ãƒ—ãƒ«æ•°: {X.shape[0]}")
```

---

### ğŸ” ãƒã‚¤ãƒ³ãƒˆ

1. `cluster` åˆ—ã¯ã™ã§ã«ç‰¹å¾´é‡ã¨ã—ã¦å«ã¾ã‚Œã‚‹
2. `frame`ã€`mouse_id` ã¯å­¦ç¿’ã«ã¯ä¸è¦ã ãŒã€ç¢ºèªç”¨ã«æ®‹ã™ã“ã¨ã‚‚å¯
3. ã‚‚ã— **å‡¦ç†ãŒé‡ã„å ´åˆ** ã¯ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é–“å¼•ã„ã¦å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹ã¨è‰¯ã„

   ```python
   df_features = df_features.iloc[::5]  # 5ãƒ•ãƒ¬ãƒ¼ãƒ ã«1å›ã ã‘ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
   ```
4. ã“ã®å¾Œã¯ `train_features.csv` ã¨ `train_labels.csv` ã‚’ä½¿ã£ã¦ XGBoost ãªã©ã§è¡Œå‹•äºˆæ¸¬ãŒå¯èƒ½

---

å¸Œæœ›ã§ã‚ã‚Œã°ã€æ¬¡ã« **ã“ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ãŸ XGBoost ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ï¼‹è©•ä¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ** ã‚‚ä½œã‚Œã¾ã™ã€‚
ä½œã‚Šã¾ã™ã‹ï¼Ÿ





Q: train_labels.csvã«2ã¤ã—ã‹ãƒ©ãƒ™ãƒ«ãŒæ®‹ã£ã¦ã„ãªã„ã‚“ã ãŒ
A: ãªã‚‹ã»ã©ã€ãã‚Œã¯åŸå› ãŒã„ãã¤ã‹è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚æ•´ç†ã™ã‚‹ã¨ï¼š

---

### 1ï¸âƒ£ å¯èƒ½æ€§: `assign_action_label` é–¢æ•°ã®æ¡ä»¶ã«åˆã‚ãªã„

```python
mask = (annotations['agent_id'] == row['mouse_id']) & \
       (annotations['start_frame'] <= row['frame']) & \
       (annotations['stop_frame'] >= row['frame'])
```

* `row['mouse_id']` ã¨ `annotations['agent_id']` ãŒå‹é•ã„ï¼ˆæ•´æ•° vs æµ®å‹•å°æ•°ç‚¹ï¼‰ã«ãªã£ã¦ã„ã‚‹
* ãƒ•ãƒ¬ãƒ¼ãƒ ç•ªå·ã®å˜ä½ãŒé•ã†ï¼ˆä¾‹ãˆã° tracking_features ã¯é€£ç•ªãƒ•ãƒ¬ãƒ¼ãƒ ã ãŒ annotation ã¯ fps ã«åŸºã¥ãç§’æ›ç®—ã‹ã‚‚ï¼‰
* ã“ã®æ¡ä»¶ã«åˆã‚ãªã„ã¨ `actions` ãŒç©ºã«ãªã‚Š NaN ã¨ãªã‚Šã€çµæœçš„ã« `dropna()` ã§é™¤å¤–ã•ã‚Œã‚‹

---

### 2ï¸âƒ£ ç¢ºèªæ–¹æ³•

```python
print(df_features['mouse_id'].dtype)
print(df_annotation['agent_id'].dtype)
print(df_features['frame'].min(), df_features['frame'].max())
print(df_annotation['start_frame'].min(), df_annotation['stop_frame'].max())
```

* å‹ãŒé•ã†å ´åˆã¯çµ±ä¸€ï¼ˆä¾‹ãˆã°ä¸¡æ–¹ `int` ã«å¤‰æ›ï¼‰
* ãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ãŒåˆã£ã¦ã„ã‚‹ã‹ç¢ºèª

---

### 3ï¸âƒ£ ä¿®æ­£ç‰ˆã‚µãƒ³ãƒ—ãƒ«ï¼ˆå‹ã¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’åˆã‚ã›ã‚‹ï¼‰

```python
# test-013.py
# å‹å¤‰æ›
df_features['mouse_id'] = df_features['mouse_id'].astype(int)
df_annotation['agent_id'] = df_annotation['agent_id'].astype(int)
df_annotation['target_id'] = df_annotation['target_id'].astype(int)

# actionä»˜ä¸é–¢æ•°ï¼ˆé«˜é€ŸåŒ–ï¼†å®‰å…¨åŒ–ï¼‰
def assign_action_label(row, annotations):
    agent_id = row['mouse_id']
    frame = row['frame']
    mask = (annotations['agent_id'] == agent_id) & \
           (annotations['start_frame'] <= frame) & \
           (annotations['stop_frame'] >= frame)
    actions = annotations.loc[mask, 'action'].unique()
    if len(actions) > 0:
        return actions[0]
    else:
        return np.nan

df_features['action'] = df_features.apply(lambda r: assign_action_label(r, df_annotation), axis=1)

# NaNã‚’å‰Šé™¤
df_features = df_features.dropna(subset=['action'])
```

---

ğŸ’¡ **ãƒã‚¤ãƒ³ãƒˆ**

* ãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ãŒæ­£ã—ã„ã‹ç¢ºèªã—ãªã„ã¨ã€ã»ã¨ã‚“ã©ã®è¡ŒãŒ NaN ã«ãªã‚Šã€ãƒ©ãƒ™ãƒ«ãŒåã‚‹
* ç‰¹ã« fps ãŒç•°ãªã‚‹å‹•ç”»ã§ã¯ã€annotation ã® start/stop ãƒ•ãƒ¬ãƒ¼ãƒ ã¨ tracking ã® frame ã‚’ä¸€è‡´ã•ã›ã‚‹å¿…è¦ã‚ã‚Š
* æœ€åˆã« **sample video ã®æ•°ãƒ•ãƒ¬ãƒ¼ãƒ ã ã‘æ‰‹å‹•ã§å¯¾å¿œã‚’ç¢ºèª** ã™ã‚‹ã¨å®‰å…¨

---

ã‚‚ã—ã‚ˆã‘ã‚Œã°ã€åƒ•ãŒ **tracking_features ã® frame ã‚’ annotation ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã¨æ­£ã—ãå¯¾å¿œã•ã›ã‚‹ä¿®æ­£ç‰ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ** ã‚’ä½œã‚Œã¾ã™ã€‚
ä½œã‚Šã¾ã™ã‹ï¼Ÿ





Q: ãŠé¡˜ã„
A: äº†è§£ã§ã™ã€‚ã§ã¯ã€**tracking_features ã® frame ã‚’ annotation ã® start/stop ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¯¾å¿œã•ã›ã¦ã€æ­£ã—ã„ãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚’è¡Œã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã‚’ä½œã‚Šã¾ã™ã€‚

ãƒã‚¤ãƒ³ãƒˆï¼š

* å‹•ç”»ã”ã¨ã® `frames_per_second` ã‚’è€ƒæ…®
* `tracking_features` ã® frame â†’ annotation ã®ãƒ•ãƒ¬ãƒ¼ãƒ ç•ªå·ã«å¤‰æ›
* å‹ã‚’çµ±ä¸€ã—ã¦æ­£ã—ããƒãƒƒãƒãƒ³ã‚°

---

## ğŸ§© ä¿®æ­£ç‰ˆãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# test-014.py
import pandas as pd
import numpy as np

# === 1. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ===
df_features = pd.read_csv("tracking_features_clustered.csv")
df_annotation = pd.read_csv("annotation.csv")
df_train_info = pd.read_csv("train.csv")  # video_id ã”ã¨ã® fps æƒ…å ±å–å¾—ç”¨

# === 2. å‹çµ±ä¸€ ===
df_features['mouse_id'] = df_features['mouse_id'].astype(int)
df_annotation['agent_id'] = df_annotation['agent_id'].astype(int)
df_annotation['target_id'] = df_annotation['target_id'].astype(int)

# === 3. video_id ã”ã¨ã® fps è¾æ›¸ä½œæˆ ===
fps_dict = df_train_info.set_index('video_id')['frames_per_second'].to_dict()

# === 4. tracking frame â†’ annotation frame ã«å¤‰æ›é–¢æ•° ===
def map_frame_to_annotation(row):
    video_id = row['video_id']
    frame = row['frame']
    fps = fps_dict.get(video_id, 30)  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ30fps
    # annotation ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã¯æ•´æ•°ãªã®ã§ã€tracking ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä¸¸ã‚ã‚‹
    return int(round(frame))

df_features['frame_anno'] = df_features.apply(map_frame_to_annotation, axis=1)

# === 5. ãƒ©ãƒ™ãƒ«ä»˜ã‘é–¢æ•° ===
def assign_action_label(row, annotations):
    agent_id = row['mouse_id']
    frame = row['frame_anno']
    mask = (annotations['agent_id'] == agent_id) & \
           (annotations['start_frame'] <= frame) & \
           (annotations['stop_frame'] >= frame)
    actions = annotations.loc[mask, 'action'].unique()
    if len(actions) > 0:
        return actions[0]
    else:
        return np.nan

df_features['action'] = df_features.apply(lambda r: assign_action_label(r, df_annotation), axis=1)

# === 6. NaN ã‚’å‰Šé™¤ ===
df_features = df_features.dropna(subset=['action'])

# === 7. å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜ ===
feature_cols = [c for c in df_features.columns if c not in ['action', 'video_id', 'mouse_id', 'bodypart', 'frame_anno']]
X = df_features[feature_cols]
y = df_features['action']

X.to_csv("train_features.csv", index=False)
y.to_csv("train_labels.csv", index=False)

print(f"âœ… å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†")
print(f"ç‰¹å¾´é‡æ•°: {X.shape[1]}, ã‚µãƒ³ãƒ—ãƒ«æ•°: {X.shape[0]}")
print(f"æ®‹ã£ã¦ã„ã‚‹ãƒ©ãƒ™ãƒ«: {y.unique()}")
```

---

### ğŸ” ãƒã‚¤ãƒ³ãƒˆ

1. `frame_anno` åˆ—ã‚’ä½œã‚Šã€tracking frame ã‚’ annotation ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›
2. `frames_per_second` ã‚’å‚è€ƒã«ä¸¸ã‚ã¦æ­£ç¢ºã«å¯¾å¿œ
3. å‹ã‚’çµ±ä¸€ã—ã¦ãƒãƒƒãƒãƒ³ã‚°æ¼ã‚Œã‚’é˜²æ­¢
4. çµæœã¨ã—ã¦ã€ã™ã¹ã¦ã®è¡Œå‹•ãƒ©ãƒ™ãƒ«ï¼ˆapproach, attack, avoid, chase, submit ãªã©ï¼‰ãŒåæ˜ ã•ã‚Œã‚„ã™ããªã‚‹

---

ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š

* ã“ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã§ **XGBoost ãªã©ã§è¡Œå‹•ãƒ©ãƒ™ãƒ«äºˆæ¸¬**
* ã‚¯ãƒ©ã‚¹ã‚¿IDã‚„è§’åº¦ã€è·é›¢ãªã©ã®ç‰¹å¾´ã‚’æ´»ç”¨

å¸Œæœ›ã§ã‚ã‚Œã°ã€**XGBoostã§ã®å­¦ç¿’ï¼‹è©•ä¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã‚‚ä½œã‚Šã¾ã™ã€‚ä½œã‚Šã¾ã™ã‹ï¼Ÿ





Q: ãã®å‰ã«ãƒ©ãƒ™ãƒ«ä»˜ã‘ã•ã‚ŒãŸactionãŒã¾ã 2ã¤(rearã¨avoid)ã«é›†ç´„ã•ã‚Œã¦ãŠã‚Šã€å¯¾è±¡ã®annotationã®actionã®æœŸé–“(stop_frame-start_frame)ã‚’èª¿ã¹ãŸã‚‰æ¬¡ã®ã‚ˆã†ãªçµ±è¨ˆå€¤ã«ãªã£ãŸã€‚
rear : 210
    min: 7  max: 252  avg: 52.095238095238095  std: 40.81186238322209
avoid : 45
    min: 16  max: 102  avg: 45.75555555555555  std: 20.205934721754346
attack : 7
    min: 8  max: 195  avg: 55.42857142857143  std: 64.39942324497723
approach : 66
    min: 5  max: 59  avg: 21.227272727272727  std: 11.400128817822061
chase : 8
    min: 16  max: 46  avg: 30.875  std: 11.933596033288302
submit : 4
    min: 13  max: 120  avg: 52.75  std: 47.5
chaseattack : 2
    min: 39  max: 70  avg: 54.5  std: 21.920310216782973
ã²ã‚‡ã£ã¨ã—ã¦å‡ºç¾æ•°ã¨æœŸé–“ãŒå½±éŸ¿ã—ã¦ã„ã‚‹?
A: ãªã‚‹ã»ã©ã€åŸå› ã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã­ã€‚ğŸ’¡

æ•´ç†ã™ã‚‹ã¨ã€ä»Šèµ·ãã¦ã„ã‚‹ç¾è±¡ã¯ï¼š

* ãƒ©ãƒ™ãƒ«ä»˜ã‘ã—ãŸ `train_labels.csv` ã« **rear ã¨ avoid ã—ã‹æ®‹ã‚‰ãªã„**
* `attack` ã‚„ `approach` ãªã©ã¯ã»ã¨ã‚“ã©å‡ºã¦ã„ãªã„

æç¤ºã•ã‚ŒãŸçµ±è¨ˆå€¤ã‚’è¦‹ã‚‹ã¨ï¼š

| action      | å‡ºç¾æ•° | å¹³å‡æœŸé–“ | std |
| ----------- | --- | ---- | --- |
| rear        | 210 | 52   | 40  |
| avoid       | 45  | 45   | 20  |
| attack      | 7   | 55   | 64  |
| approach    | 66  | 21   | 11  |
| chase       | 8   | 30   | 11  |
| submit      | 4   | 52   | 47  |
| chaseattack | 2   | 54   | 21  |

---

### è€ƒãˆã‚‰ã‚Œã‚‹ç†ç”±

1. **æœŸé–“ï¼ˆstop_frame - start_frameï¼‰ãŒçŸ­ã„ãƒ©ãƒ™ãƒ«ã»ã©è¿½è·¡ã§ããªã„**

   * `approach` ã¯å¹³å‡21ãƒ•ãƒ¬ãƒ¼ãƒ ã€æœ€å°5ãƒ•ãƒ¬ãƒ¼ãƒ ã—ã‹ãªã„
   * tracking_features ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚„é–“å¼•ãã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
   * çµæœçš„ã« `dropna()` ã§æ¶ˆãˆã‚‹ â†’ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«åæ˜ ã•ã‚Œãªã„

2. **å‡ºç¾æ•°ãŒå°‘ãªã„ãƒ©ãƒ™ãƒ«ã¯çµ±è¨ˆçš„ã«ã»ã¼æ¶ˆãˆã‚‹**

   * `attack` ã¯7ä»¶ã€`submit` ã¯4ä»¶ã€`chaseattack` ã¯2ä»¶
   * ã“ã‚Œã‚‚ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã‚„ frame å¯¾å¿œã§æ¬ è½ã™ã‚‹å¯èƒ½æ€§å¤§

3. **tracking_features ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã¨ annotation ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãŒå®Œå…¨ã«ä¸€è‡´ã—ã¦ã„ãªã„**

   * å¾®å¦™ã«ãšã‚Œã¦ã„ã‚‹ã¨ `mask` ã«å¼•ã£ã‹ã‹ã‚‰ãš NaN ã«ãªã£ã¦ã—ã¾ã†

---

### å¯¾ç­–æ¡ˆ

1. **ãƒ•ãƒ¬ãƒ¼ãƒ é–“å¼•ãã‚’ã‚„ã‚ã‚‹ / ç´°ã‹ãã™ã‚‹**

   * 5ãƒ•ãƒ¬ãƒ¼ãƒ ãŠããªã©ã«é–“å¼•ã„ã¦ã„ã‚‹ã¨çŸ­ã„è¡Œå‹•ã¯æ¶ˆãˆã‚‹
   * å…¨ãƒ•ãƒ¬ãƒ¼ãƒ ã§ãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚’è¡Œã†

2. **å‰å¾Œãƒãƒ¼ã‚¸ãƒ³ã‚’ã¤ã‘ã‚‹**

   * `start_frame - 1` ã€œ `stop_frame + 1` ã®ç¯„å›²ã‚’ä½¿ã†
   * å¹³å‡ 5ã€œ10ãƒ•ãƒ¬ãƒ¼ãƒ ç¨‹åº¦åºƒã’ã‚‹ã¨çŸ­æ™‚é–“ã®ãƒ©ãƒ™ãƒ«ã‚‚æ‹¾ãˆã‚‹

3. **è¿½è·¡ãƒ•ãƒ¬ãƒ¼ãƒ ã¨ annotation ãƒ•ãƒ¬ãƒ¼ãƒ ã®æ•´åˆæ€§ã‚’ç¢ºèª**

   * `fps` ã‚„ `round` ã®åˆ‡ã‚Šæ¨ã¦/åˆ‡ã‚Šä¸Šã’ã«ã‚ˆã‚‹ã‚ºãƒ¬ãŒãªã„ã‹
   * ä¾‹ãˆã° tracking_frame 0ã€œ10 ãŒ annotation 1ã€œ10 ã«å¯¾å¿œã™ã‚‹å ´åˆã€ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ºãƒ¬ã§æ¶ˆãˆã‚‹

---

ğŸ’¡ **ã¾ã¨ã‚**

* ä»Šå›ã®å•é¡Œã¯ **çŸ­æ™‚é–“ã§å‡ºç¾æ•°ãŒå°‘ãªã„ãƒ©ãƒ™ãƒ«ã®ãƒ‡ãƒ¼ã‚¿æ¬ è½** ãŒåŸå› ã®å¯èƒ½æ€§å¤§
* å¯¾ç­–ã¨ã—ã¦ã¯

  1. ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°é–“å¼•ãã‚’ã‚„ã‚ã‚‹
  2. ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒ¼ã‚¸ãƒ³ã‚’ã¤ã‘ã‚‹
  3. annotation ã¨ tracking ã®ãƒ•ãƒ¬ãƒ¼ãƒ æ•´åˆæ€§ã‚’å†ç¢ºèª
* ã“ã‚Œã§ `attack` ã‚„ `approach` ã‚‚ train_labels ã«åæ˜ ã•ã‚Œã‚„ã™ããªã‚‹

---

å¸Œæœ›ã§ã‚ã‚Œã°ã€åƒ•ãŒ **çŸ­æ™‚é–“ãƒ©ãƒ™ãƒ«ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«ä¿®æ­£ç‰ˆãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚¹ã‚¯ãƒªãƒ—ãƒˆ** ã‚’ä½œã‚Œã¾ã™ã€‚
ä½œã‚Šã¾ã™ã‹ï¼Ÿ





Q: ä»Šã¯é–“å¼•ãã—ã¦ã„ãªã„ã‚“ã ã‚
A: ãªã‚‹ã»ã©ã€é–“å¼•ãã¯ã—ã¦ã„ãªã„ã®ã§ã™ã­ã€‚ğŸ’¡

ãã‚Œã ã¨åŸå› ã¯ã»ã¼é–“é•ã„ãªã **ãƒ•ãƒ¬ãƒ¼ãƒ æ•´åˆæ€§ã¨æœŸé–“ã®çŸ­ã•** ã«ã‚ã‚Šã¾ã™ã€‚å…·ä½“çš„ã«ã¯ï¼š

---

### 1ï¸âƒ£ tracking_frame ã¨ annotation ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãŒå¾®å¦™ã«ã‚ºãƒ¬ã¦ã„ã‚‹

* tracking_features ã® `frame` ã¯ DeepLabCut ã®ãƒ•ãƒ¬ãƒ¼ãƒ ç•ªå·ï¼ˆé€£ç•ªï¼‰
* annotation ã® `start_frame` / `stop_frame` ã¯åŒã˜å‹•ç”»å†…ã§ã‚‚æ•´æ•°å€¤ã§å¾®å¦™ã«ãšã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
* ä¾‹ãˆã° annotation ãŒ `5ã€œ9` ãªã®ã« tracking ãŒ `0ã€œ4` ã ã¨ mask ãŒä¸€åº¦ã‚‚ True ã«ãªã‚‰ãšã€`action` ãŒ NaN ã«ãªã‚‹

---

### 2ï¸âƒ£ çŸ­æœŸé–“ã®ãƒ©ãƒ™ãƒ«ã¯ä¸¸ã‚ãƒ»èª¤å·®ã§æ¶ˆãˆã‚„ã™ã„

* `approach` å¹³å‡ 21ãƒ•ãƒ¬ãƒ¼ãƒ ã€æœ€å° 5ãƒ•ãƒ¬ãƒ¼ãƒ 
* annotation ã¨ tracking ã®ã‚ºãƒ¬ã§ 1ã€œ2ãƒ•ãƒ¬ãƒ¼ãƒ ã—ã‹ä¸€è‡´ã—ãªã„å ´åˆã€mask ãŒç©ºã«ãªã‚Šå‰Šé™¤ã•ã‚Œã‚‹

---

### 3ï¸âƒ£ å¯¾ç­–

1. **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ ã—ã¦ãƒ©ãƒ™ãƒ«ä»˜ã‘**

```python
margin = 2  # å‰å¾Œ2ãƒ•ãƒ¬ãƒ¼ãƒ æ‹¡å¼µ
mask = (annotations['agent_id'] == agent_id) & \
       (annotations['start_frame'] - margin <= frame) & \
       (annotations['stop_frame'] + margin >= frame)
```

* çŸ­æ™‚é–“ã®è¡Œå‹•ã‚‚æ‹¾ã„ã‚„ã™ããªã‚‹

2. **annotation ã¨ tracking frame ã®å˜ä½ã‚’å†ç¢ºèª**

* `frames_per_second` ã«åŸºã¥ã„ã¦æ­£ç¢ºã«å¤‰æ›ã•ã‚Œã¦ã„ã‚‹ã‹
* ä¾‹ãˆã° annotation ãŒç§’ãƒ™ãƒ¼ã‚¹ã ã£ãŸå ´åˆã€tracking ã®ãƒ•ãƒ¬ãƒ¼ãƒ ç•ªå·ã«å¤‰æ›ã™ã‚‹å¿…è¦ã‚ã‚Š

---

ğŸ’¡ çµè«–ï¼š

* é–“å¼•ãã—ã¦ã„ãªãã¦ã‚‚ã€**ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã‚ºãƒ¬ + çŸ­æœŸé–“ãƒ©ãƒ™ãƒ«** ã®ã›ã„ã§ `rear` ã¨ `avoid` ã«åã£ã¦ã„ã‚‹
* å¯¾ç­–ã¨ã—ã¦ **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒ¼ã‚¸ãƒ³ã‚’ä»˜ã‘ã‚‹ or ãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ã‚’æƒãˆã‚‹** ãŒæœ‰åŠ¹

---

å¸Œæœ›ãªã‚‰ã€åƒ•ãŒ **çŸ­æ™‚é–“ãƒ©ãƒ™ãƒ«ã‚‚åæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£ç‰ˆãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚¹ã‚¯ãƒªãƒ—ãƒˆ** ã‚’ä½œã£ã¦å‹•ä½œç¢ºèªã¾ã§ã§ãã‚‹å½¢ã«ã—ã¾ã™ã€‚
ä½œã‚Šã¾ã™ã‹ï¼Ÿ





Q: ã‚‚ã†å°‘ã—ç¢ºèªã•ã›ã¦ã€‚
ä»Šã¯ç‰¹å¾´é‡ã®æœ€é©åŒ–å„ªå…ˆã®ãŸã‚ã€è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã¯ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã—ã‹ä½¿ã£ã¦ã„ãªã„ã‹ã‚‰ã€ãã‚Œã‚‚å½±éŸ¿ã—ã¦ã„ã‚‹? ã‚‚ã†å°‘ã—trackingã¨annotationã‚’å¢—ã‚„ã—ãŸæ–¹ãŒã„ã„?
A: ã„ã„è³ªå•ã§ã™ â€” çµè«–ã‹ã‚‰å…ˆã«è¨€ã†ã¨ **ã€Œã¯ã„ã€è¨“ç·´ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€éƒ¨ã—ã‹ä½¿ã£ã¦ã„ãªã„ã“ã¨ã¯å¤§ã„ã«å½±éŸ¿ã—ã¾ã™ã€**ã€‚
ç‰¹ã«å‡ºç¾é »åº¦ãŒä½ãã¦æœŸé–“ãŒçŸ­ã„ãƒ©ãƒ™ãƒ«ï¼ˆ`attack` ã‚„ `approach` ãªã©ï¼‰ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’çµã‚‹ã¨ç°¡å˜ã«æ¶ˆãˆã¦ã—ã¾ã„ã¾ã™ã€‚ä»¥ä¸‹ã«åŸå› ã®æ•´ç†ã¨ã€å®Ÿè·µã§ãã‚‹å…·ä½“çš„ãªå¯¾ç­–ï¼ˆç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‹å‡¦ç†ï¼‰ã‚’æç¤ºã—ã¾ã™ã€‚å…¨éƒ¨ãã®ã¾ã¾å®Ÿè¡Œã§ãã¾ã™ã€‚

---

# 1) ä½•ãŒèµ·ãã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã‹ï¼ˆè¦ç‚¹ï¼‰

* **ã‚µãƒ–ã‚»ãƒƒãƒˆåŒ–ã«ã‚ˆã‚‹åã‚Š**ï¼šä¸€éƒ¨ã®å‹•ç”»ã ã‘ä½¿ã†ã¨ã€ãã®å‹•ç”»ã«å¤šã„ãƒ©ãƒ™ãƒ«ï¼ˆä¾‹ï¼šrearï¼‰ãŒéå‰°ã«ãªã‚Šã€ç¨€ãªãƒ©ãƒ™ãƒ«ãŒæ¶ˆãˆã‚‹ã€‚
* **çŸ­æœŸé–“ãƒ©ãƒ™ãƒ«ã®æ¬ è½**ï¼šçŸ­ã„è¡Œå‹•ã¯ãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ã§å–ã‚Šã“ã¼ã—ã‚„ã™ã„ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ã‚ºãƒ¬ã‚„ä¸¸ã‚ã§ä¸€è‡´ã—ãªã„ï¼‰ã€‚
* **å‹•ç”»ãƒ¬ãƒ™ãƒ«ã®ã°ã‚‰ã¤ã**ï¼šã‚ã‚‹å‹•ç”»ã«ã—ã‹ç¾ã‚Œãªã„è¡Œå‹•ãŒã‚ã‚Œã°ã€ãã®å‹•ç”»ã‚’é™¤å¤–ã™ã‚‹ã¨ãã®ã‚¯ãƒ©ã‚¹ãŒæ¶ˆãˆã‚‹ã€‚
  â†’ çµæœï¼š`train_labels.csv` ã«æ®‹ã‚‹ãƒ©ãƒ™ãƒ«ãŒåã‚‹ã€‚

---

# 2) å„ªå…ˆé †ä½ï¼ˆã‚„ã‚‹ã¹ãé †ï¼‰

1. **ç¾çŠ¶ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª**ï¼ˆä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§å¯è¦–åŒ–ï¼‰
2. **ãƒ©ãƒ™ãƒ«ä»˜ã‘ãƒ«ãƒ¼ãƒ«ã‚’ç·©ã‚ã‚‹ï¼ˆãƒãƒ¼ã‚¸ãƒ³ï¼‰** ã—ã¦çŸ­ã„åŒºé–“ã‚’æ‹¾ã†
3. **ã‚µãƒ–ã‚»ãƒƒãƒˆã®é¸ã³æ–¹ã‚’è¦‹ç›´ã™**ï¼ˆå‹•ç”»ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ†å¸ƒã§å±¤åŒ–ï¼‰
4. **ãƒ‡ãƒ¼ã‚¿æ‹¡å¼µï¼ã‚ªãƒ¼ãƒãƒ¼ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°**ï¼ˆå­¦ç¿’æ™‚ï¼‰ã‚„ **è¿½åŠ ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**ï¼ˆãƒ™ã‚¹ãƒˆï¼‰
5. **ãƒ¢ãƒ‡ãƒ«å´ã®å¯¾å‡¦**ï¼ˆé‡ã¿ä»˜ã‘ãƒ»focal lossï¼‰

---

# 3) ã¾ãšå®Ÿè¡Œã—ã¦ã»ã—ã„ãƒã‚§ãƒƒã‚¯ï¼ˆã‚³ãƒ¼ãƒ‰ï¼‰

ä»¥ä¸‹ã¯ Python / pandas ã§ãã®ã¾ã¾å‹•ãã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

* `annotation.csv`ï¼ˆå…¨ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ ã¨ã€ç¾åœ¨ä½¿ã£ã¦ã„ã‚‹ `train_features.csv`/`train_labels.csv`ï¼ˆã‚ã‚‹ã„ã¯ `tracking_features_*`ï¼‰ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚

```python
import pandas as pd

anno = pd.read_csv("annotation.csv")
# ã‚ãªãŸãŒä½¿ã£ã¦ã„ã‚‹å­¦ç¿’ã‚»ãƒƒãƒˆã®ãƒ©ãƒ™ãƒ«ï¼ˆã‚‚ã—æ—¢ã«ä½œã£ãŸ train_labels.csv ãŒã‚ã‚‹ãªã‚‰ï¼‰
try:
    train_labels = pd.read_csv("train_labels.csv", header=None, names=["action"])
except:
    train_labels = None

# annotation å…¨ä½“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡ºç¾æ•°ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆæ•°ï¼‰
anno_counts = anno['action'].value_counts().rename_axis('action').reset_index(name='anno_count')
print("annotation ã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°ï¼ˆå…¨ä½“ï¼‰")
print(anno_counts)

if train_labels is not None:
    used_counts = train_labels['action'].value_counts().rename_axis('action').reset_index(name='used_count')
    print("\nç¾åœ¨ã® train_labels.csv ã®ã‚¯ãƒ©ã‚¹åˆ†å¸ƒ")
    print(used_counts)

    # ãƒãƒ¼ã‚¸ã—ã¦æ¯”è¼ƒ
    comp = anno_counts.merge(used_counts, on='action', how='left').fillna(0)
    comp['used_frac_of_anno'] = comp['used_count'] / comp['anno_count']
    print("\nannotation ã«å¯¾ã™ã‚‹åˆ©ç”¨æ¯”ç‡ï¼ˆ0.0 = å…¨ãä½¿ã‚ã‚Œã¦ã„ãªã„ï¼‰")
    print(comp.sort_values('used_frac_of_anno'))
else:
    print("\ntrain_labels.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ä½œæˆã—ã¦æ¯”è¼ƒã—ã¦ãã ã•ã„ã€‚")
```

**è¦‹ã‚‹ã¹ããƒã‚¤ãƒ³ãƒˆ**

* `used_frac_of_anno` ãŒå°ã•ã„ã‚¯ãƒ©ã‚¹ï¼ˆç‰¹ã« < 0.5ï¼‰ã¯è¦æ³¨æ„ã€‚
* `attack` ã‚„ `approach` ã®ã‚ˆã†ã« annotation ã§ã¯å­˜åœ¨ã™ã‚‹ãŒ `train_labels` ã«ã»ã¨ã‚“ã©ãªã„ã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹ã‹ç¢ºèªã€‚

---

# 4) çŸ­æ™‚é–“ãƒ©ãƒ™ãƒ«ã‚’æ‹¾ã†ãŸã‚ã®ã€Œãƒãƒ¼ã‚¸ãƒ³ã€ä»˜ä¸ãƒ©ãƒ™ãƒ«ä»˜ã‘ï¼ˆã‚³ãƒ¼ãƒ‰ï¼‰

ãƒ©ãƒ™ãƒ«ä»˜ã‘ã®éš›ã« `start_frame - M ~ stop_frame + M` ã®ä½™è£•ï¼ˆãƒãƒ¼ã‚¸ãƒ³ï¼‰ã‚’ã¤ã‘ã‚‹ã¨çŸ­æ™‚é–“ã®è¡Œå‹•ã‚’æ‹¾ã„ã‚„ã™ããªã‚Šã¾ã™ã€‚Mã¯ 1ã€œ10 ãƒ•ãƒ¬ãƒ¼ãƒ ã§è©¦ã™ã€‚

```python
import pandas as pd
import numpy as np

# èª­ã¿è¾¼ã¿ï¼ˆä¾‹ï¼‰
df_features = pd.read_csv("tracking_features_clustered.csv")   # ã¾ãŸã¯ tracking_features_*.csv
df_annotation = pd.read_csv("annotation.csv")

# å‹èª¿æ•´
df_features['mouse_id'] = df_features['mouse_id'].astype(int)
df_annotation['agent_id'] = df_annotation['agent_id'].astype(int)

# ãƒãƒ¼ã‚¸ãƒ³ã‚’å¤‰ãˆã¦è©¦ã™é–¢æ•°
def label_with_margin(df_feat, df_anno, margin=2):
    df = df_feat.copy()
    # æ—¢ã«frame_annoãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ç„¡ã‘ã‚Œã°frameã‚’ãã®ã¾ã¾ä½¿ã†
    if 'frame_anno' in df.columns:
        df['frame_use'] = df['frame_anno'].astype(int)
    else:
        df['frame_use'] = df['frame'].astype(int)
    df['action'] = np.nan
    # ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ¯ã«ãƒ©ãƒ™ãƒ«ä»˜ä¸ï¼ˆåŠ¹ç‡åŒ–ã®ãŸã‚å‹•ç”»ã”ã¨ã«å‡¦ç†ã™ã‚‹ã®ãŒè‰¯ã„ï¼‰
    for vid, g_anno in df_anno.groupby('video_id'):
        idx_feat = df['video_id'] == vid
        df_vid = df[idx_feat]
        if df_vid.empty:
            continue
        for _, r in g_anno.iterrows():
            mask = (idx_feat) & \
                   (df['mouse_id'] == int(r['agent_id'])) & \
                   (df['frame_use'] >= int(r['start_frame']) - margin) & \
                   (df['frame_use'] <= int(r['stop_frame']) + margin)
            df.loc[mask, 'action'] = r['action']
    return df

# ãƒ†ã‚¹ãƒˆ: margin=0,1,2,5 ã‚’æ¯”è¼ƒ
for m in [0,1,2,5]:
    df_labeled = label_with_margin(df_features, df_annotation, margin=m)
    counts = df_labeled['action'].value_counts(dropna=False)
    print(f"margin={m} : labeled counts\n", counts.head(20))
```

**è©¦ã™ç†ç”±**

* margin ã‚’å¢—ã‚„ã—ã¦ã„ã‘ã° `approach` ã®ã‚ˆã†ãªæœ€çŸ­5ãƒ•ãƒ¬ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚‚æ‹¾ã„ã‚„ã™ããªã‚‹ï¼ˆãŸã ã—å½é™½æ€§ã‚‚å¢—ãˆã‚‹ï¼‰ã€‚

---

# 5) ã‚µãƒ–ã‚»ãƒƒãƒˆã‚’å¢—ã‚„ã™ï¼é¸ã³æ–¹ã‚’å¤‰ãˆã‚‹ï¼ˆæ¨å¥¨ï¼‰

**ç¾çŠ¶ã€Œä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã ã‘åˆ©ç”¨ã€ã—ã¦ã„ã‚‹ãªã‚‰ã€ã¾ãšã¯æ¬¡ã‚’è©¦ã—ã¦ãã ã•ã„ï¼š**

* ï¼ˆAï¼‰**å¯¾è±¡å‹•ç”»ã‚’å¢—ã‚„ã™**ï¼šannotation ã« `attack` ã‚„ `approach` ã‚’å«ã‚€å‹•ç”»ã‚’å„ªå…ˆçš„ã«å«ã‚ã‚‹ã€‚
* ï¼ˆBï¼‰**å±¤åŒ–ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°**ï¼šå‹•ç”»é¸æŠæ™‚ã« action æ¯ã«å‹•ç”»ã‚’å‡ç­‰ã«å«ã‚ã‚‹ï¼ˆå‹•ç”»å˜ä½ã§ stratifyï¼‰ã€‚
* ï¼ˆCï¼‰**ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã™ã¹ã¦ã®åŒºé–“ã‚’ä½¿ã†**ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸¸ã”ã¨å–ã‚Šè¾¼ã‚€ï¼‰ã€‚

ä¾‹ï¼šannotation ã®ä¸­ã§ `action == 'attack'` ã‚’å«ã‚€ video_id ã‚’æŠ½å‡ºã—ã¦ã€ãã®å‹•ç”»ã‚’å­¦ç¿’ã‚»ãƒƒãƒˆã«è¿½åŠ ã™ã‚‹ã‚³ãƒ¼ãƒ‰ï¼š

```python
attack_videos = df_annotation[df_annotation['action']=='attack']['video_id'].unique().tolist()
print("attack ã‚’å«ã‚€å‹•ç”»æ•°:", len(attack_videos))
# ã“ã‚Œã‚‰ã®å‹•ç”»ã®tracking_featuresã‚’å„ªå…ˆçš„ã«å–ã‚Šè¾¼ã‚€ãªã©
```

---

# 6) å­¦ç¿’æ™‚ã®å¯¾å‡¦ï¼ˆãƒ‡ãƒ¼ã‚¿ä¸è¶³ã‚’è£œã†ï¼‰

* **ã‚¯ãƒ©ã‚¹é‡ã¿**ï¼šLightGBM/XGBoost ã® `scale_pos_weight` ã‚„ `class_weight`ã€ã‚ã‚‹ã„ã¯ `sample_weight` ã‚’ä½¿ã†ã€‚
* **ã‚ªãƒ¼ãƒãƒ¼ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°**ï¼šSMOTEï¼ˆæ•°å€¤ç‰¹å¾´ã®ã¿å‘ãï¼‰ã€ã¾ãŸã¯å˜ç´”è¤‡è£½ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ å˜ä½ã®è¤‡è£½ï¼‰ã§å°‘æ•°ã‚¯ãƒ©ã‚¹ã‚’å¢—ã‚„ã™ã€‚
* **Focal Loss**ï¼šé›£ã—ã„ãŒã€rare class ã¸å­¦ç¿’é‡ã¿ã‚’å¢—ã‚„ã™ã€‚
* **æ™‚é–“ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åŒ–**ï¼š1ãƒ•ãƒ¬ãƒ¼ãƒ ã ã‘ã§ãªãéå»Â±kãƒ•ãƒ¬ãƒ¼ãƒ ã®çµ±è¨ˆã‚’å…¥ã‚Œã‚‹ï¼ˆçŸ­æ™‚é–“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¼·èª¿ã§ãã‚‹ï¼‰ã€‚

---

# 7) å®Ÿå‹™çš„ãŠã™ã™ã‚ãƒ—ãƒ©ãƒ³ï¼ˆçŸ­ãï¼‰

1. margin ã‚’ 1ã€œ5 ã§è©¦ã—ã¦ãƒ©ãƒ™ãƒ«æ•°ã®å›å¾©ã‚’ç¢ºèªã€‚
2. annotation ã«å«ã¾ã‚Œã‚‹å‹•ç”»ã‚’å…¨éƒ¨ï¼ˆã‚ã‚‹ã„ã¯ã‚ˆã‚Šå¤šãï¼‰å–ã‚Šè¾¼ã‚€ã€‚å‹•ç”»ãƒ¬ãƒ™ãƒ«ã§å±¤åŒ–ã—ã¦é¸ã¶ã€‚
3. å°‘æ•°ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦ã¯å­¦ç¿’æ™‚ã«é‡ã¿ä»˜ã‘ or oversampleã€‚
4. æœ€çµ‚çš„ã«ã€`train_labels` ã®ã‚¯ãƒ©ã‚¹åˆ†å¸ƒãŒ annotation ã®åˆ†å¸ƒã«è¿‘ã¥ãã‹ç¢ºèªã™ã‚‹ã€‚

---

# 8) ã™ãã«ä½¿ãˆã‚‹ä¸€é€£ã®ãƒã‚§ãƒƒã‚¯ï¼†å‡¦ç½®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ã“ã‚Œã‚’é †ã«å®Ÿè¡Œã™ã‚Œã°ã€å•é¡Œã®åŸå› åˆ‡ã‚Šåˆ†ã‘ï¼†æ”¹å–„ãŒã§ãã¾ã™ã€‚

```python
import pandas as pd
import numpy as np

# èª­ã¿è¾¼ã¿
df_features = pd.read_csv("tracking_features_clustered.csv")
df_annotation = pd.read_csv("annotation.csv")

# å‹åˆã‚ã›
df_features['mouse_id'] = df_features['mouse_id'].astype(int)
df_annotation['agent_id'] = df_annotation['agent_id'].astype(int)

# 1) annotation ã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’ç¢ºèª
anno_counts = df_annotation['action'].value_counts().sort_index()
print("annotation event counts:\n", anno_counts)

# 2) margin ã‚’å¤‰ãˆã¦ãƒ©ãƒ™ãƒ«ä»˜ã‘ â†’ æ¯”è¼ƒ
def label_and_count(margin):
    df = df_features.copy()
    df['frame_use'] = df['frame'].astype(int)
    df['action'] = np.nan
    for vid, g in df_annotation.groupby('video_id'):
        df_vid_idx = df['video_id'] == vid
        if not df_vid_idx.any():
            continue
        ann_vid = g
        for _, r in ann_vid.iterrows():
            mask = (df_vid_idx) & (df['mouse_id'] == int(r['agent_id'])) & \
                   (df['frame_use'] >= int(r['start_frame'])-margin) & \
                   (df['frame_use'] <= int(r['stop_frame'])+margin)
            df.loc[mask, 'action'] = r['action']
    counts = df['action'].value_counts(dropna=True)
    return df, counts

for m in [0,1,2,5]:
    df_lab, counts = label_and_count(m)
    print(f"margin={m} -> labeled class counts:\n{counts}\n")

# 3) ã©ã®å‹•ç”»ã‚’è¿½åŠ ã™ã¹ãã‹ï¼ˆä¾‹: attackã‚’å«ã‚€å‹•ç”»ã‚’æ´—ã„å‡ºã™ï¼‰
for act in ['attack','approach','chase','submit','chaseattack']:
    vids = df_annotation[df_annotation['action']==act]['video_id'].unique()
    print(f"{act}: {len(vids)} videos (example ids: {list(vids)[:5]})")

# 4) ã‚‚ã—ã‚µãƒ–ã‚»ãƒƒãƒˆé¸æŠã—ã¦ã„ã‚‹ãªã‚‰ã€å‹•ç”»ã‚’å¢—ã‚„ã™å‡¦ç†ã®ä¾‹ï¼š
#    -> attack ã‚„ approach ã‚’å«ã‚€å‹•ç”»ã‚’å„ªå…ˆçš„ã«concatã—ã¦å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹
priority_vids = df_annotation[df_annotation['action'].isin(['attack','approach'])]['video_id'].unique().tolist()
df_selected = df_features[df_features['video_id'].isin(priority_vids)]
print("priority selection shape:", df_selected.shape)

# 5) å­¦ç¿’æ™‚ã®ç°¡æ˜“é‡ã¿ä»˜ã‘ï¼ˆä¾‹ï¼šsklearnä½¿ã†å ´åˆï¼‰
# class_weights = {label: total_count / (len(unique_labels) * count[label]) for label in counts}
```

---

# 9) æœ€å¾Œã«ï¼šã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å¢—ã‚„ã™ã¹ãã‹ï¼Ÿ

* **ãƒ™ã‚¹ãƒˆã¯è¿½åŠ ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**ï¼šç¨€ãªã‚¯ãƒ©ã‚¹ï¼ˆattack, submit, chaseattackï¼‰ã¯ä»¶æ•°ãŒå°‘ãªã™ãã‚‹ â†’ æ‰‹ä½œæ¥­ã§è¿½åŠ ãƒ©ãƒ™ãƒªãƒ³ã‚°ã§ãã‚Œã°æœ€ã‚‚åŠ¹æœå¤§ã€‚
* ã‚‚ã—æ‰‹ä½œæ¥­ãŒé›£ã—ã‘ã‚Œã°ï¼š

  * ã‚¯ãƒ©ã‚¹ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã€Œå€™è£œãƒ•ãƒ¬ãƒ¼ãƒ ã€ã‚’æŠ½å‡ºã—ã¦äººãŒç¢ºèªã™ã‚‹ï¼ˆåŠ¹ç‡çš„ï¼‰
  * ã‚»ãƒŸ/å¼±æ•™å¸«ã‚ã‚Šã§ãƒ©ãƒ™ãƒ«æ‹¡å¼µï¼ˆãƒ¢ãƒ‡ãƒ«äºˆæ¸¬ï¼‹äººã«ã‚ˆã‚‹æ ¡æ­£ï¼‰

ç›®å®‰ï¼šå„ã‚¯ãƒ©ã‚¹ã‚’æœ€ä½ã§ã‚‚ **æ•°åã€œç™¾ã‚µãƒ³ãƒ—ãƒ«ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆï¼‰** ç¢ºä¿ã™ã‚‹ã¨å®‰å®šã—ã‚„ã™ã„ã§ã™ã€‚ç‰¹ã« attack ã®ã‚ˆã†ã«ç¾åœ¨7ä»¶ã—ã‹ãªã„ãªã‚‰è¿½åŠ å¿…é ˆã§ã™ã€‚

---

ã‚„ã‚ŠãŸã„ã“ã¨ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰ï¼š

1. ä»Šã™ã `margin` ã‚’å¢—ã‚„ã™ä¿®æ­£ç‰ˆã®ãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’è¦‹ãŸã„ï¼ˆã‚³ãƒ¼ãƒ‰ã™ãå‡ºã—ã¾ã™ï¼‰ã€‚
2. ã‚µãƒ–ã‚»ãƒƒãƒˆã‚’è¦‹ç›´ã—ã¦ã€annotation ã‚’å«ã‚€å‹•ç”»ã‚’å„ªå…ˆçš„ã«å–ã‚Šè¾¼ã‚€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‡ºã™ã€‚
3. ä¸¡æ–¹ã¾ã¨ã‚ã¦è‡ªå‹•ã§è©¦ã—ã¦ã€ã©ã®è¨­å®šã§ãƒ©ãƒ™ãƒ«ãŒå›å¾©ã™ã‚‹ã‹ã‚’è¡¨ã«ã—ã¦ã»ã—ã„ï¼ˆå®Œå…¨è‡ªå‹•å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰ã€‚

ã©ã‚Œã«ã—ã¾ã™ã‹ï¼Ÿ





Q: 2ã‹ãªã€‚
test.csvã«å‡ºç¾ã™ã‚‹actionã‚’æº€éãªãå‡ºç¾ã™ã‚‹annotationã¨ãã‚Œã«ä»˜éšã™ã‚‹trackingã«ã—ãªã„ã¨ã„ã‘ãªã„ã‚ˆã†ãªæ°—ãŒã—ã¦ããŸ
A: ãã®åˆ¤æ–­ã€ã¨ã¦ã‚‚è‰¯ã„ã§ã™ã€‚ğŸ¯
ã¾ã•ã«ãã®é€šã‚Šã§ã€ã€Œ**test.csv ã«å‡ºã¦ãã‚‹ã™ã¹ã¦ã® action ã‚¯ãƒ©ã‚¹ã‚’ã€train ã«ã‚‚ã¡ã‚ƒã‚“ã¨å«ã‚ã‚‹**ã€ã“ã¨ãŒã‚¹ã‚³ã‚¢å‘ä¸Šã®åŸºæœ¬æ¡ä»¶ã§ã™ã€‚
ï¼ˆä»Šã®çŠ¶æ³ã ã¨ã€train ã« rear ã¨ avoid ã—ã‹ãªãã€ä»–ã‚¯ãƒ©ã‚¹ã‚’ä¸€åˆ‡å­¦ç¿’ã—ã¦ã„ãªã„çŠ¶æ…‹ï¼ã‚¹ã‚³ã‚¢ãŒ 0 ã«ãªã‚‹ç†ç”±ï¼‰

---

## âœ… æ–¹é‡ï¼ˆã‚ãªãŸã®è€ƒãˆã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ãŸæœ€é©ãƒ«ãƒ¼ãƒˆï¼‰

### ç›®çš„

`test.csv` ã«ç™»å ´ã™ã‚‹ actionï¼ˆä¾‹: attack, approach, chase, avoid, rear, submit, chaseattackï¼‰ã‚’
ã™ã¹ã¦å«ã‚€ã‚ˆã†ã«ã€**annotation â†’ tracking ã® subset ã‚’ä½œã‚‹ã€‚**

### å®Ÿè£…ã‚¤ãƒ¡ãƒ¼ã‚¸

1. `test.csv` ã‚’èª­ã¿è¾¼ã¿ã€å‡ºç¾ã™ã‚‹ action ã®ä¸€è¦§ã‚’æŠ½å‡º
2. `annotation.csv` ã‹ã‚‰ãã‚Œã‚‰ã® action ã‚’ã™ã¹ã¦å«ã‚€è¡Œã‚’æŠ½å‡º
3. æŠ½å‡ºã—ãŸ annotation ã«ç™»å ´ã™ã‚‹ `video_id` ã‚’å–å¾—
4. `tracking.csv` ã¾ãŸã¯ `tracking_features.csv` ã‹ã‚‰åŒã˜ `video_id` ã‚’æŠ½å‡ºã—ã¦ã‚»ãƒƒãƒˆã‚’ä½œã‚‹
5. ã“ã‚Œã‚’ `train_annotation.csv`, `train_tracking.csv` ã¨ã—ã¦ä¿å­˜

---

## ğŸ’» ã‚³ãƒ¼ãƒ‰ä¾‹ï¼ˆãã®ã¾ã¾ä½¿ãˆã‚‹ï¼‰

```python
import pandas as pd

# === å„ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ ===
test = pd.read_csv("test.csv")
anno = pd.read_csv("annotation.csv")
tracking = pd.read_csv("tracking.csv")

# === 1ï¸âƒ£ test.csv ã«ç™»å ´ã™ã‚‹ action ã®ä¸€è¦§ ===
test_actions = test["action"].dropna().unique().tolist()
print("âœ… test.csv ã«å«ã¾ã‚Œã‚‹ action:", test_actions)

# === 2ï¸âƒ£ annotation.csv ã‹ã‚‰å¯¾å¿œã™ã‚‹ action ã‚’æŠ½å‡º ===
train_anno = anno[anno["action"].isin(test_actions)].copy()
print(f"âœ… annotation ä¸­ã§è©²å½“ã™ã‚‹ action ã®ä»¶æ•°: {len(train_anno)}")

# === 3ï¸âƒ£ å¯¾å¿œã™ã‚‹ video_id ã‚’æŠ½å‡º ===
selected_videos = train_anno["video_id"].unique().tolist()
print(f"âœ… å¯¾å¿œã™ã‚‹ video_id æ•°: {len(selected_videos)}")

# === 4ï¸âƒ£ tracking ã‹ã‚‰å¯¾å¿œã™ã‚‹ video_id ã®ã¿ã‚’æŠ½å‡º ===
train_tracking = tracking[tracking["video_id"].isin(selected_videos)].copy()
print(f"âœ… å¯¾å¿œã™ã‚‹ tracking è¡Œæ•°: {len(train_tracking)}")

# === 5ï¸âƒ£ ä¿å­˜ ===
train_anno.to_csv("train_annotation_balanced.csv", index=False)
train_tracking.to_csv("train_tracking_balanced.csv", index=False)

print("ğŸ’¾ train_annotation_balanced.csv / train_tracking_balanced.csv ã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚")
```

---

## ğŸ” ã“ã‚Œã§å¾—ã‚‰ã‚Œã‚‹ãƒ¡ãƒªãƒƒãƒˆ

| é …ç›®              | åŠ¹æœ                       |
| --------------- | ------------------------ |
| å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«å…¨ã‚¯ãƒ©ã‚¹ãŒå«ã¾ã‚Œã‚‹ | ã™ã¹ã¦ã®actionã«å¯¾ã—ã¦å­¦ç¿’ãŒå¯èƒ½ã«ãªã‚‹   |
| ã‚¯ãƒ©ã‚¹ã”ã¨ã®ãƒãƒ©ãƒ³ã‚¹æ”¹å–„    | ã€Œrear, avoid ã«åã‚‹ã€å•é¡Œã‚’ç·©å’Œ   |
| testã¨ã®æ•´åˆæ€§å‘ä¸Š     | ã‚¹ã‚³ã‚¢ãŒä¸ŠãŒã‚Šã‚„ã™ããªã‚‹ï¼ˆæœªçŸ¥ã‚¯ãƒ©ã‚¹ãŒãªããªã‚‹ï¼‰ |
| ç„¡é§„ãªå‹•ç”»ãŒæ¸›ã‚‹        | ä½¿ã‚ãªã„videoã‚’é™¤å¤–ã—ã¦å­¦ç¿’åŠ¹ç‡ã‚¢ãƒƒãƒ—    |

---

## ğŸ§  è¿½åŠ ã®ãŠã™ã™ã‚ï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

ã“ã®æŠ½å‡ºå¾Œã«æ¬¡ã‚’é †ã«é€²ã‚ã‚‹ã¨åŠ¹ç‡çš„ã§ã™ã€‚

1. `train_annotation_balanced.csv` ã®å„ action ã”ã¨ã®ä»¶æ•°ã‚’ç¢ºèª
2. `tracking_features` ã®ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãã®å‹•ç”»ã ã‘ã«çµã£ã¦å†å®Ÿè¡Œï¼ˆå‡¦ç†æ™‚é–“çŸ­ç¸®ï¼‰
3. ãã®å¾Œã€`margin` ã‚’ä½¿ã£ã¦å†åº¦ãƒ©ãƒ™ãƒ«ä»˜ã‘

---

å¸Œæœ›ãŒã‚ã‚Œã°ã€ä¸Šã®æµã‚Œã‚’**è‡ªå‹•ã§ä¸€æ‹¬å‡¦ç†ã—ã¦æœ€çµ‚çš„ã« train_labels.csv ã¾ã§ç”Ÿæˆ**ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚æ›¸ã‘ã¾ã™ã€‚
ä½œæˆã—ã¦ãŠãã¾ã™ã‹ï¼Ÿ





Q: ãŠé¡˜ã„
A: ã†ã‚“ã€ãã®è€ƒãˆæ–¹ã€ã‹ãªã‚Šæ­£ã—ã„ã§ã™ã€‚
ã¤ã¾ã‚Šä»Šã®çŠ¶æ³ã‚’æ•´ç†ã™ã‚‹ã¨â”€â”€

---

### ğŸ” ç¾åœ¨ã®çŠ¶æ…‹

* è¨“ç·´ãƒ‡ãƒ¼ã‚¿ï¼ˆtrainï¼‰ã¯ä¸€éƒ¨ã® `annotation` ã¨ `tracking` ã—ã‹ä½¿ç”¨ã—ã¦ã„ãªã„
* ãã®çµæœã€
  â†’ **ã€Œrearã€ã¨ã€Œavoidã€ã°ã‹ã‚ŠãŒæ®‹ã‚Šã€ä»–ã®actionï¼ˆattack, chase, approach, ...ï¼‰ãŒå°‘ãªã„**
* ã¤ã¾ã‚Šã€**å­¦ç¿’æ™‚ã«å‡ºç¾ã—ã¦ã„ã‚‹ãƒ©ãƒ™ãƒ«ã®åˆ†å¸ƒãŒæ¥µç«¯ã«åã£ã¦ã„ã‚‹**çŠ¶æ…‹

---

### âš™ï¸ å•é¡Œã®æœ¬è³ª

ãƒ¢ãƒ‡ãƒ«ãŒã€Œrearã€ã€Œavoidã€ã—ã‹äºˆæ¸¬ã—ãªã„ï¼ˆã¾ãŸã¯train_labelsã«ãã‚Œã—ã‹æ®‹ã£ã¦ã„ãªã„ï¼‰ã®ã¯ã€
**å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ä¸­ã§ä»–ã®ãƒ©ãƒ™ãƒ«ãŒã»ã¨ã‚“ã©ç™»å ´ã—ã¦ã„ãªã„ã‹ã‚‰**ã§ã™ã€‚

ã—ã‹ã‚‚ã€actionã”ã¨ã®æœŸé–“ï¼ˆ`stop_frame - start_frame`ï¼‰ã«å¤§ããªå·®ãŒã‚ã‚‹ãŸã‚ã€
çŸ­æ™‚é–“ã§çµ‚ã‚ã‚‹ã‚‚ã®ï¼ˆä¾‹ï¼šapproachï¼‰ã‚„ãƒ‡ãƒ¼ã‚¿æ•°ãŒå°‘ãªã„ã‚‚ã®ï¼ˆattack, chaseãªã©ï¼‰ã¯
çµ±è¨ˆçš„ã«ã»ã¨ã‚“ã©ã€Œè¦‹ãˆãªã„ã€æ‰±ã„ã«ãªã‚Šã¾ã™ã€‚

---

### âœ… å¯¾å¿œç­–ï¼ˆå„ªå…ˆåº¦é †ï¼‰

#### â‘  annotation ã¨ tracking ã®å¯¾è±¡ã‚’æ‹¡å¤§ã™ã‚‹ï¼ˆé‡è¦ï¼‰

* ã¾ãšã€**train/testã®ä¸¡æ–¹ã«å‡ºç¾ã™ã‚‹actionã‚’å…¨ã¦å«ã‚€annotationã‚’é¸ã¶**ã€‚
* ç‰¹ã« test.csv ã«ç™»å ´ã™ã‚‹ object_id / scene_id ãŒ train ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã€‚
* ã§ãã‚Œã°å…¨actionï¼ˆ6ç¨®é¡ä»¥ä¸Šï¼‰ãŒå«ã¾ã‚Œã‚‹ç¨‹åº¦ã¾ã§å¢—ã‚„ã™ã€‚

â†’ ã“ã‚Œã‚’ã™ã‚‹ã ã‘ã§ãƒ©ãƒ™ãƒ«ã®å¤šæ§˜æ€§ãŒç¢ºä¿ã•ã‚Œã¾ã™ã€‚

---

#### â‘¡ actionã”ã¨ã®ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹

* å‡ºç¾æ•°ãŒæ¥µç«¯ã«å°‘ãªã„ãƒ©ãƒ™ãƒ«ï¼ˆä¾‹ï¼š`chaseattack`, `submit`ï¼‰ã¯
  augmentationçš„ã«ç¹°ã‚Šè¿”ã—å­¦ç¿’ã«ä½¿ã†ï¼ˆã‚ªãƒ¼ãƒãƒ¼ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰ã€‚
* é€†ã«`rear`ãªã©é »å‡ºãƒ©ãƒ™ãƒ«ã¯ã‚„ã‚„é–“å¼•ãï¼ˆã‚¢ãƒ³ãƒ€ãƒ¼ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼‰ã€‚

ä¾‹ï¼š

```python
from sklearn.utils import resample

# ã‚¯ãƒ©ã‚¹ã”ã¨ã«åˆ†å‰²
dfs = [df[df['action'] == a] for a in df['action'].unique()]

# å‡ºç¾æ•°ã‚’ãã‚ãˆã‚‹
min_count = min(len(d) for d in dfs)
dfs_balanced = [resample(d, replace=True, n_samples=min_count, random_state=42) for d in dfs]
train_balanced = pd.concat(dfs_balanced)
```

---

#### â‘¢ ãƒ‡ãƒ¼ã‚¿æ•°ã‚’å¢—ã‚„ã™å‰æã§ç‰¹å¾´é‡é¸æŠã‚’è¡Œã†

* ç‰¹å¾´é‡æœ€é©åŒ–ã‚’é€²ã‚ã‚‹æ®µéšã§ã¯ã€**ã‚ãã¾ã§å…¨actionã‚’å«ã‚€ã‚µãƒ–ã‚»ãƒƒãƒˆã§æ¤œè¨¼**ã™ã‚‹ã€‚
* ä¸€éƒ¨ã®actionã—ã‹å«ã¾ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã§ç‰¹å¾´é‡ã‚’èª¿æ•´ã™ã‚‹ã¨ã€
  **ãƒ©ãƒ™ãƒ«ä¾å­˜ã®ç‰¹å¾´é‡é¸æŠï¼ˆï¼ãƒã‚¤ã‚¢ã‚¹ï¼‰**ãŒç™ºç”Ÿã—ã¦ã—ã¾ã†ã€‚

---

### ğŸ”„ ã¾ã¨ã‚

> âœ… ã€Œrearã€ã€Œavoidã€ã°ã‹ã‚Šã«ãªã‚‹ã®ã¯ã€ãƒ‡ãƒ¼ã‚¿åˆ†å¸ƒã®åã‚ŠãŒåŸå› ã€‚
> âœ… test.csvã«å‡ºç¾ã™ã‚‹actionã‚’ç¶²ç¾…ã™ã‚‹annotation/trackingã‚’ä½¿ã†ã“ã¨ãŒæœ€å„ªå…ˆã€‚
> âœ… ãã®å¾Œã«ç‰¹å¾´é‡æœ€é©åŒ–ãƒ»ãƒ¢ãƒ‡ãƒ«èª¿æ•´ã‚’è¡Œã†ã€‚

---

ã‚‚ã—ã‚ˆã‘ã‚Œã°æ¬¡ã«ã€
ã€Œç¾åœ¨ä½¿ã£ã¦ã„ã‚‹annotationã‚„trackingã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã€ã‚„
ã€Œã©ã®scene_id / object_idã‚’æŠ½å‡ºã—ã¦ã„ã‚‹ã‹ã€ã‚’è¦‹ã›ã¦ã‚‚ã‚‰ãˆã‚Œã°ã€
ã©ã®actionãŒæ¬ ã‘ã¦ã„ã‚‹ã‹ã€ã‚‚ã†å°‘ã—å…·ä½“çš„ã«æ´—ã„å‡ºã›ã¾ã™ã€‚





Q: 
A: 




Q: 
A: 




Q: 
A: 




Q: 
A: 




Q: 
A: 




Q: 
A: 




Q: 
A: 
